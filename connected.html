<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>You are Connected</title>
    <link rel="stylesheet" href="styles.css"> <!-- Link to external CSS -->
    
    <!-- Firebase scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.9.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.9.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.9.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.9.0/firebase-storage-compat.js"></script>

    <!-- Cropper.js -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
</head>
<body>   

    <div class="sidebar" id="sidebar">
        <h2 id="welcomeHeader">Welcome, [userId]!</h2>
        
        <!-- Directly include the search bar and lists -->
        <input type="text" id="userSearchBar" placeholder="Search by User ID" oninput="filterUsers()">
    
        <!-- User list for search results -->
        <div class="user-list" id="userList"></div> <!-- Ensure this is still included -->
            
        <h3>Pending Friend Requests</h3>
        <div class="request-list" id="requestList"></div>
        
        <h3>Accepted Friends</h3>
        <div class="accepted-list" id="acceptedList"></div>
    
        <button id="logoutBtn">Log Out</button>
    </div>

    <div class="main-content">
        <div class="event-box">
            <div class="event-controls">
                <button id="createEventBtn" style="width: 125px; height: 50px;">Create Event</button>
                <button id="toggleMenuBtn" style="width: 125px; height: 50px;">My Account</button>
            </div>
            <button id="toggleEventsBtn">Show Future Events</button>
            <div class="past-events">
                <div class="event-list" id="pastEventList"></div> <!-- Container for past events -->
            </div>
            <div class="future-events">
                <div class="event-list" id="futureEventList"></div> <!-- Container for future events -->
            </div>
        </div>
        
        <!-- Picture Upload Section -->
        <!-- <h3>Upload a Picture</h3 -->
        <input type="file" id="uploadPictureInput" class="hidden" accept="image/*" style="margin: 10px 0;">
        <button id="uploadPictureBtn" class="hidden">Upload Picture</button>
        <div id="uploadStatus" class="hidden"></div> <!-- Status message -->
    </div>

    <!-- Existing modal code and scripts remain unchanged -->
</body>

    <!-- Modal for Event Creation -->
    <div id="eventModal" style="display: none;" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3>Create Event</h3>
            <label for="eventTitle">Event Title:</label>
            <input type="text" id="eventTitle" required>
            <br>
            <label for="eventDate">Event Date:</label>
            <input type="date" id="eventDate" required>
            <br>
            <label for="eventTime">Event Time:</label>
            <input type="time" id="eventTime" required>
            <br>
            <label for="eventLocation">Event Location:</label>
            <input type="text" id="eventLocation" required>
            <br>
            <label for="eventComment">Event Comment:</label>
            <textarea id="eventComment" maxlength="200" rows="4" required></textarea>
            <br>
            <label for="eventCategory">Category:</label>
            <select id="eventCategory" required>
                <option value="" disabled selected>Select a category</option>
                <option value="apero">Apero</option>
                <option value="coffee">Coffee</option>
                <option value="lunch">Lunch</option>
                <option value="dinner">Dinner</option>
                <option value="workout">Workout</option>
                <option value="party">Party</option>
                <option value="other">Other</option>
            </select>
            <br>

            <button id="selectAllBtn">Select All Friends</button> <!-- Super button -->
            <div id="friendsList" class="friends-list"></div>

            <button id="submitEventBtn">Create Event</button>
        </div>
    </div>

    <!-- Modal for Event Details -->
    <div id="eventDetailsModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeEventDetailsModal()">&times;</span>
            <h3>Event Details</h3>
            <h4>Participants</h4>
            <div id="participantList"></div>
            
            <!-- Picture Carousel Section -->
            <h3>Event Pictures</h3>
            <div id="eventPicturesCarousel" class="carousel">
                <button id="prevBtn">Previous</button>
                <div id="carouselImages"></div>
                <button id="nextBtn">Next</button>
            </div>
            
            <!-- Picture Upload Section -->
            <h3>Upload a Picture</h3>
            <input type="file" id="eventUploadPictureInput" accept="image/*" style="margin: 10px 0;">
            <button id="eventUploadPictureBtn">Upload Picture</button>
            <div id="eventUploadStatus" class="message"></div> <!-- Status message for upload -->
        
            <button id="joinEventBtn">Join!</button>
            <button id="deleteEventBtn" style="display: none;">Delete Event</button>
        </div>
    </div>

    <div id="cropModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 9999;">
        <div style="position: relative; width: 90%; margin: auto; top: 50%; transform: translateY(-50%);">
            <img id="cropperImage" src="" style="max-width: 100%;"/>
            <button id="cropBtn" style="position: absolute; bottom: 10px; left: 10px;">Crop & Upload</button>
            <button id="cancelBtn" style="position: absolute; bottom: 10px; right: 10px;">Cancel</button>
        </div>
    </div>

    <script>
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBB61hJK8iHNAXz2q5u8ghGqIFMyJh-Nho",
            authDomain: "aperosocial-d53c7.firebaseapp.com",
            databaseURL: "https://aperosocial-d53c7-default-rtdb.firebaseio.com",
            projectId: "aperosocial-d53c7",
            storageBucket: "aperosocial-d53c7.firebasestorage.app",
            messagingSenderId: "954205055992",
            appId: "1:954205055992:web:c2ebebe1c0ac210163440d"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        const storage = firebase.storage(); // Initialize Firebase Storage

        // Upload picture functionality for event details modal
        document.getElementById('eventUploadPictureBtn').onclick = function () {
            const fileInput = document.getElementById('eventUploadPictureInput');
            const file = fileInput.files[0]; // Get the selected file

            console.log("Upload button clicked"); // Log when the upload button is clicked
            
            if (!file) {
                document.getElementById('eventUploadStatus').textContent = "Please select a file.";
                console.warn("No file selected"); // Log a warning if no file is selected
                return;
            }
        
            const imageUrl = URL.createObjectURL(file);
            const cropImageElement = document.getElementById('cropperImage');
            cropImageElement.src = imageUrl; // Set the source for cropping

            console.log("Image URL created:", imageUrl); // Log the image URL
        
            const modal = document.getElementById('cropModal');
            modal.style.display = 'block'; // Show the crop modal
        
            const cropper = new Cropper(cropImageElement, {
                aspectRatio: 1,
                viewMode: 1,
            });
        
            document.getElementById('cropBtn').onclick = function () {
                console.log("Crop button clicked"); // Log when the crop button is clicked
                const canvas = cropper.getCroppedCanvas({
                    width: 1080,
                    height: 1080,
                });
                canvas.toBlob(function(blob) {
                    console.log("Cropped image blob created:", blob); // Log the blob created
                    uploadCroppedImage(blob); // Call to upload function
                });
        
                modal.style.display = 'none'; // Hide the modal after cropping
            };
        
            document.getElementById('cancelBtn').onclick = function () {
                console.log("Crop modal cancelled"); // Log when the crop modal is cancelled
                modal.style.display = 'none'; // Hide the modal if cancelled
            };
        };

        let allUsers = [];

        let currentImageIndex = 0;

        let showFutureEvents = true; // Default to showing future events

        // Add this line to set the button text based on the initial state
        document.getElementById('toggleEventsBtn').textContent = showFutureEvents ? 'Show Past Events' : 'Show Future Events';

        document.getElementById('prevBtn').onclick = function () {
            const images = document.querySelectorAll('#carouselImages img');
            if (images.length > 0) {
                currentImageIndex = (currentImageIndex - 1 + images.length) % images.length; // Loop back to last image
                updateCarousel();
            }
        };
        
        document.getElementById('nextBtn').onclick = function () {
            const images = document.querySelectorAll('#carouselImages img');
            if (images.length > 0) {
                currentImageIndex = (currentImageIndex + 1) % images.length; // Loop back to first image
                updateCarousel();
            }
        };
        
        function updateCarousel() {
            const images = document.querySelectorAll('#carouselImages img');
            images.forEach((img, index) => {
                img.style.display = index === currentImageIndex ? 'block' : 'none'; // Show only the current image
            });
        }

        const categoryColors = {
            apero: '#FFA07A',   // Light Salmon
            coffee: '#FFD700',  // Gold
            lunch: '#90EE90',   // Light Green
            dinner: '#ADD8E6',  // Light Blue
            workout: '#FFB6C1', // Light Pink
            party: '#9370DB',   // Medium Purple
            other: '#D3D3D3'    // Light Gray
        };

        // Function to fetch and display users
        function displayUsers() {
            const currentUserId = auth.currentUser.uid; // Get current user's Firebase UID
            const userList = document.getElementById('userList'); // Reference to the user list container
            
            database.ref('users').once('value').then(snapshot => {
                userList.innerHTML = ''; // Clear previous list
                allUsers = []; // Reset the allUsers array
        
                snapshot.forEach(childSnapshot => {
                    const userData = childSnapshot.val();
                    const userId = userData.userId;
                    const targetUserId = childSnapshot.key; // Get the UID of the user
        
                    // Exclude the currently logged-in user
                    if (targetUserId === currentUserId) {
                        return; // Skip adding the current user to the list
                    }
        
                    // Store user data for filtering
                    allUsers.push({ userId, uid: targetUserId });
        
                    // Create a user item
                    const userItem = document.createElement('div');
                    userItem.classList.add('user-item');
                    userItem.textContent = userId;
        
                    // Create the action button (existing logic)
                    const actionButton = document.createElement('button');
        
                    // Determine the button text and functionality
                    // (Add button logic here...)
        
                    // Append the action button to the user item
                    userItem.appendChild(actionButton);
                    userList.appendChild(userItem);
                });
        
                // Hide the user list initially
                userList.style.display = 'none';
            }).catch(error => {
                console.error("Error fetching users:", error);
            });
        }

        function filterUsers() {
            const searchValue = document.getElementById('userSearchBar').value.toLowerCase();
            const userList = document.getElementById('userList');
            userList.innerHTML = ''; // Clear the user list
        
            // Check if the search bar is empty
            if (searchValue === '') {
                userList.style.display = 'none'; // Hide the user list
                return; // Exit the function
            } else {
                userList.style.display = 'block'; // Show the user list
            }
        
            // Filter and display users based on the search
            let hasResults = false; // Flag to check if any results are found
        
            allUsers.forEach(user => {
                if (user.userId.toLowerCase().includes(searchValue)) {
                    hasResults = true; // Indicate that a result has been found
        
                    // Check if the user is already in the list to prevent duplicates
                    const existingUserItems = userList.getElementsByClassName('user-item');
                    const userExists = Array.from(existingUserItems).some(item => item.textContent === user.userId);
        
                    if (!userExists) {
                        // Create and display the user item
                        const userItem = document.createElement('div');
                        userItem.classList.add('user-item');
                        userItem.textContent = user.userId;
        
                        // Create the action button (existing logic)
                        const actionButton = document.createElement('button');
        
                        // Determine the button text and functionality
                        const currentUserId = auth.currentUser.uid; // Get current user's Firebase UID
                        const targetUserId = user.uid; // Get the UID of the user being displayed
        
                        // Check for incoming friend requests
                        database.ref(`users/${currentUserId}/friendRequests/${targetUserId}`).once('value').then(friendSnapshot => {
                            if (friendSnapshot.exists()) {
                                if (friendSnapshot.val().status === 'pending') {
                                    actionButton.textContent = 'Pending';
                                    actionButton.disabled = true; // Disable the button
                                } else if (friendSnapshot.val().status === 'accepted') {
                                    actionButton.textContent = 'Friends';
                                    actionButton.disabled = true; // Disable the button
                                }
                            } else {
                                // Check for outgoing friend requests
                                database.ref(`users/${targetUserId}/friendRequests/${currentUserId}`).once('value').then(requestSnapshot => {
                                    if (requestSnapshot.exists()) {
                                        if (requestSnapshot.val().status === 'pending') {
                                            actionButton.textContent = 'Pending';
                                            actionButton.disabled = true; // Disable the button
                                        }
                                    } else {
                                        // If no requests exist, show a "+" button
                                        actionButton.textContent = '+';
                                        actionButton.onclick = function () {
                                            sendFriendRequest(targetUserId, actionButton); // Pass the UID and button
                                        };
                                    }
                                });
                            }
        
                            // Append the action button to the user item
                            userItem.appendChild(actionButton);
                            userList.appendChild(userItem);
                        });
                    }
                }
            });
        
            // If no results were found, hide the user list
            if (!hasResults) {
                userList.style.display = 'none'; // Hide the user list if no matches
            }
        }

        // Function to send a friend request
        function sendFriendRequest(targetUserId, button) {
            const currentUserId = auth.currentUser.uid; // Get current user's Firebase UID
            
            // Update the database to add the friend request under the target user's record
            database.ref('users/' + targetUserId + '/friendRequests/' + currentUserId).set({
                requestingUserId: currentUserId,
                status: 'pending'
            }).then(() => {
                console.log("Friend request sent to " + targetUserId);
                button.textContent = 'Pending'; // Change button text to "Pending"
                button.disabled = true; // Disable the button
            }).catch(error => {
                console.error("Error sending friend request:", error);
            });
        }

        // Function to fetch and display pending friend requests
        function displayPendingRequests() {
            const currentUserId = auth.currentUser.uid; // Get current user's Firebase UID
            
            database.ref('users/' + currentUserId + '/friendRequests').once('value').then(snapshot => {
                const requestList = document.getElementById('requestList');
                requestList.innerHTML = ''; // Clear previous list

                const pendingRequests = snapshot.val();
                if (pendingRequests) {
                    const requestsArray = Object.keys(pendingRequests);
                    requestsArray.forEach(requesterId => {
                        // Check if the request is still pending
                        if (pendingRequests[requesterId].status === 'pending') {
                            // Fetch userId of the requester
                            database.ref('users/' + requesterId).once('value').then(userSnapshot => {
                                const requesterData = userSnapshot.val();
                                if (requesterData) {
                                    const requestItem = document.createElement('div');
                                    requestItem.classList.add('request-item');
                                    requestItem.textContent = requesterData.userId; // Display the userId of the requester
                                    
                                    // Create a tick button for the recipient
                                    const acceptButton = document.createElement('button');
                                    acceptButton.textContent = '✓';
                                    acceptButton.onclick = function() {
                                        acceptFriendRequest(requesterId); // Pass the requester UID
                                    };

                                    // Append tick button to request item
                                    requestItem.appendChild(acceptButton);
                                    requestList.appendChild(requestItem); // Add to the list
                                }
                            });
                        }
                    });
                }
            }).catch(error => {
                console.error("Error fetching friend requests:", error);
            });
        }

        // Function to fetch and display accepted friends
        function displayAcceptedFriends() {
            const currentUserId = auth.currentUser.uid; // Get current user's Firebase UID
            
            database.ref('users/' + currentUserId + '/friendRequests').once('value').then(snapshot => {
                const acceptedList = document.getElementById('acceptedList');
                acceptedList.innerHTML = ''; // Clear previous list

                const requests = snapshot.val();
                if (requests) {
                    const requestsArray = Object.keys(requests);
                    requestsArray.forEach(requesterId => {
                        if (requests[requesterId].status === 'accepted') {
                            // Fetch userId of the accepted requester
                            database.ref('users/' + requesterId).once('value').then(userSnapshot => {
                                const requesterData = userSnapshot.val();
                                if (requesterData) {
                                    const acceptedItem = document.createElement('div');
                                    acceptedItem.classList.add('accepted-item');
                                    acceptedItem.textContent = requesterData.userId; // Display the userId of the accepted friend
                                    acceptedList.appendChild(acceptedItem); // Add to the list
                                }
                            });
                        }
                    });
                }
            }).catch(error => {
                console.error("Error fetching accepted friends:", error);
            });
        }

        // Function to accept a friend request
        function acceptFriendRequest(requesterId) {
            const currentUserId = auth.currentUser.uid; // Get current user's Firebase UID
        
            // Update the database to change the status of the friend request
            database.ref('users/' + currentUserId + '/friendRequests/' + requesterId).update({
                status: 'accepted'
            }).then(() => {
                console.log("Friend request from " + requesterId + " accepted.");
        
                // Update the sender's request status to accepted
                database.ref('users/' + requesterId + '/friendRequests/' + currentUserId).set({
                    requestingUserId: currentUserId,
                    status: 'accepted'
                }).then(() => {
                    // Fetch requester's events
                    database.ref('users/' + requesterId + '/events').once('value').then(snapshot => {
                        const events = snapshot.val();
                        if (events) {
                            const eventIds = Object.keys(events);
        
                            // Add currentUserId to the visibleTo field of each event
                            eventIds.forEach(eventId => {
                                database.ref(`users/${requesterId}/events/${eventId}/visibleTo`).once('value').then(visibleToSnapshot => {
                                    const visibleTo = visibleToSnapshot.val() || [];
                                    if (!visibleTo.includes(currentUserId)) {
                                        database.ref(`users/${requesterId}/events/${eventId}`).update({
                                            visibleTo: [...visibleTo, currentUserId]
                                        }).then(() => {
                                            console.log(`Added ${currentUserId} to visibleTo for event ${eventId}`);
                                        }).catch(error => {
                                            console.error("Error updating event viewers:", error);
                                        });
                                    }
                                });
                            });
                        } else {
                            console.log("No events found for requester.");
                        }
                    }).catch(error => {
                        console.error("Error fetching requester's events:", error);
                    });
        
                    // Fetch current user's events
                    database.ref('users/' + currentUserId + '/events').once('value').then(snapshot => {
                        const events = snapshot.val();
                        if (events) {
                            const eventIds = Object.keys(events);
        
                            // Add requesterId to the visibleTo field of each event
                            eventIds.forEach(eventId => {
                                database.ref(`users/${currentUserId}/events/${eventId}/visibleTo`).once('value').then(visibleToSnapshot => {
                                    const visibleTo = visibleToSnapshot.val() || [];
                                    if (!visibleTo.includes(requesterId)) {
                                        database.ref(`users/${currentUserId}/events/${eventId}`).update({
                                            visibleTo: [...visibleTo, requesterId]
                                        }).then(() => {
                                            console.log(`Added ${requesterId} to visibleTo for event ${eventId}`);
                                        }).catch(error => {
                                            console.error("Error updating event viewers:", error);
                                        });
                                    }
                                });
                            });
                        } else {
                            console.log("No events found for current user.");
                        }
                    }).catch(error => {
                        console.error("Error fetching user's events:", error);
                    });
        
                    displayPendingRequests(); // Refresh the pending requests display
                    displayAcceptedFriends(); // Refresh the accepted friends display
                    displayAllEvents(); // Refresh friends' events display
                });
            }).catch(error => {
                console.error("Error accepting friend request:", error);
            });
        }

        // Function to create an event
        function createEvent() {
            const modal = document.getElementById("eventModal");
            modal.style.display = "block"; // Show the modal
            displayFriends(); // Call the function to display friends
        }
        
        // Function to fetch and display friends
        function displayFriends() {
            const currentUserId = auth.currentUser.uid; // Get current user's Firebase UID
            const friendsList = document.getElementById('friendsList');
            friendsList.innerHTML = ''; // Clear previous list
        
            // Fetch accepted friends
            database.ref('users/' + currentUserId + '/friendRequests').once('value').then(snapshot => {
                const requests = snapshot.val();
                if (requests) {
                    const requestsArray = Object.keys(requests);
                    requestsArray.forEach(friendId => {
                        if (requests[friendId].status === 'accepted') {
                            // Fetch userId of the friend
                            database.ref('users/' + friendId).once('value').then(userSnapshot => {
                                const friendData = userSnapshot.val();
                                if (friendData) {
                                    const friendItem = document.createElement('div');
                                    friendItem.classList.add('friend-item');
        
                                    // Create a checkbox
                                    const checkbox = document.createElement('input');
                                    checkbox.type = 'checkbox';
                                    checkbox.id = friendId; // Use friend's UID as ID
                                    checkbox.value = friendData.userId; // Store userId as value
                                    checkbox.checked = true; // Automatically check the checkbox
        
                                    // Append the checkbox and friend name
                                    friendItem.appendChild(checkbox);
                                    friendItem.appendChild(document.createTextNode(friendData.userId));
                                    friendsList.appendChild(friendItem); // Add to the list
                                }
                            });
                        }
                    });
                }
            }).catch(error => {
                console.error("Error fetching friends:", error);
            });
        }
        
        // Function to toggle all friend checkboxes
        function toggleAllFriends() {
            const checkboxes = document.querySelectorAll('#friendsList input[type="checkbox"]');
            const allChecked = Array.from(checkboxes).every(checkbox => checkbox.checked);
        
            checkboxes.forEach(checkbox => {
                checkbox.checked = !allChecked; // Toggle the checked state
            });
        }
        
        // Add event listener to the "Select All Friends" button
        document.getElementById('selectAllBtn').onclick = toggleAllFriends;

        function submitEvent() {
            const title = document.getElementById("eventTitle").value;
            const date = document.getElementById("eventDate").value;
            const time = document.getElementById("eventTime").value;
            const location = document.getElementById("eventLocation").value; // Get the location
            const comment = document.getElementById("eventComment").value; // Get the comment
            const category = document.getElementById("eventCategory").value; // Get the selected category
        
            if (title && date && time && location && comment && category) { // Check if all fields are filled
                const currentUserId = auth.currentUser.uid; // Get current user's Firebase UID
                const eventKey = database.ref('users/' + currentUserId + '/events').push().key; // Create a unique key for the event
        
                // Collect selected friends' IDs
                const selectedFriends = [];
                const checkboxes = document.querySelectorAll('#friendsList input[type="checkbox"]');
                checkboxes.forEach(checkbox => {
                    if (checkbox.checked) {
                        selectedFriends.push(checkbox.id); // Add friend's UID to the list
                    }
                });
        
                database.ref('users/' + currentUserId + '/events/' + eventKey).set({
                    title: title,
                    date: date,
                    time: time,
                    location: location, // Store the location
                    comment: comment, // Store the comment
                    category: category, // Store the selected category
                    createdBy: currentUserId, // Store the creator's user ID
                    visibleTo: selectedFriends // Store the list of friends who can see the event
                }).then(() => {
                    alert("Event created successfully!");
                    displayAllEvents(); // Refresh the events display
                    closeModal(); // Close the modal
                }).catch(error => {
                    console.error("Error creating event:", error);
                });
            } else {
                alert("All fields are required!");
            }
        }

        // Function to close the modal
        function closeModal() {
            const modal = document.getElementById("eventModal");
            modal.style.display = "none"; // Hide the modal
            document.getElementById("eventTitle").value = '';
            document.getElementById("eventDate").value = '';
            document.getElementById("eventTime").value = '';
        }

        let currentEventId; // Declare a variable to hold the current event ID
        
        function openEventDetails(event) {
            currentEventId = event.id; // Store the current event ID
            const currentUserId = auth.currentUser.uid; // Get the current user's UID
            const eventDetailsModal = document.getElementById('eventDetailsModal');
            const deleteEventBtn = document.getElementById('deleteEventBtn');
            const joinEventBtn = document.getElementById('joinEventBtn');
            const participantList = document.getElementById('participantList');
            const carouselImages = document.getElementById('carouselImages');
        
            // Show or hide the delete button based on creator
            if (event.createdBy === currentUserId) {
                deleteEventBtn.style.display = "block";
                deleteEventBtn.onclick = () => deleteEvent(event.createdBy, event.id);
                joinEventBtn.style.display = "none"; // Hide the Join button for the creator
            } else {
                deleteEventBtn.style.display = "none";
        
                // Set up the "Join!" button for non-creators
                database.ref(`users/${event.createdBy}/events/${event.id}/participants`)
                    .once('value')
                    .then(snapshot => {
                        const participants = snapshot.val() || [];
                        const isParticipant = participants.includes(currentUserId);
        
                        // Update button text based on participation status
                        joinEventBtn.textContent = isParticipant ? 'Leave Event' : 'Join!';
                        joinEventBtn.style.display = "block"; // Ensure the button is visible
                        joinEventBtn.onclick = function() {
                            toggleParticipation(event.createdBy, event.id, currentUserId, joinEventBtn);
                        };
                    });
            }
        
            // Fetch and display pictures in the carousel
            database.ref(`events/${event.id}/pictures`).once('value').then(snapshot => {
                carouselImages.innerHTML = ''; // Clear previous images
                snapshot.forEach(childSnapshot => {
                    const pictureData = childSnapshot.val();
                    const img = document.createElement('img');
                    img.src = pictureData.url;
                    img.alt = "Event Picture";
                    img.style.width = "100%"; // Set width to 100% for full width
                    img.style.height = "auto"; // Maintain aspect ratio
                    img.style.margin = "5px"; // Add margin
        
                    carouselImages.appendChild(img);
                });
            }).catch(error => {
                console.error("Error fetching event pictures:", error);
            });
        
            eventDetailsModal.style.display = "block"; // Show the modal
        }

        function displayParticipants(creatorId, eventId, participantList) {
            const participantsRef = database.ref(`users/${creatorId}/events/${eventId}/participants`);
        
            participantsRef.once('value').then(snapshot => {
                const participantUids = snapshot.val() || []; // Get the list of UIDs
        
                if (participantUids.length === 0) {
                    participantList.textContent = "No participants yet.";
                    return;
                }
        
                // Clear the participant list before adding new entries
                participantList.innerHTML = '';
        
                // Fetch and display the userId for each UID
                participantUids.forEach(uid => {
                    database.ref(`users/${uid}`).once('value').then(userSnapshot => {
                        const userData = userSnapshot.val();
                        const userId = userData ? userData.userId : "Unknown User"; // Fallback if userId is not found
        
                        // Create a list item for the participant
                        const participantItem = document.createElement('div');
                        participantItem.textContent = userId; // Display the userId
                        participantList.appendChild(participantItem); // Add to the list
                    }).catch(error => {
                        console.error("Error fetching userId for UID:", uid, error);
                    });
                });
            }).catch(error => {
                console.error("Error fetching participants:", error);
                participantList.textContent = "Unable to load participants.";
            });
        }

        function toggleParticipation(creatorId, eventId, userId, button) {
            const participantsRef = database.ref(`users/${creatorId}/events/${eventId}/participants`);
            
            participantsRef.once('value').then(snapshot => {
                let participants = snapshot.val() || []; // Get the current list of participants
        
                if (participants.includes(userId)) {
                    // User is already a participant, remove them
                    participants = participants.filter(participant => participant !== userId);
                    button.textContent = 'Join!'; // Update button text
                    button.style.backgroundColor = 'green'; // Set to green
                } else {
                    // User is not a participant, add them
                    participants.push(userId);
                    button.textContent = 'Leave Event'; // Update button text
                    button.style.backgroundColor = 'red'; // Set to red
                }
        
                // Update the participants list in the database
                participantsRef.set(participants)
                    .then(() => {
                        console.log(`Participation toggled for user ${userId} in event ${eventId}`);
                        
                        // Refresh the participant list in the UI
                        // refreshParticipants(creatorId, eventId);
                    })
                    .catch(error => {
                        console.error('Error updating participants:', error);
                    });
            });
        }

        function deleteEvent(creatorId, eventId) {
            const currentUserId = auth.currentUser.uid; // Get current user's Firebase UID
        
            // Confirm deletion
            if (confirm("Are you sure you want to delete this event? This action cannot be undone.")) {
                // Remove the event from the creator's events
                database.ref('users/' + creatorId + '/events/' + eventId).remove()
                    .then(() => {
                        console.log("Event deleted successfully.");
                        displayAllEvents(); // Refresh the events display
                        
                        // Close the modal after deletion
                        closeEventDetailsModal(); // Call the function to close the modal
                    })
                    .catch(error => {
                        console.error("Error deleting event:", error);
                    });
            }
        }
        
        // Function to close the event details modal
        function closeEventDetailsModal() {
            const eventDetailsModal = document.getElementById('eventDetailsModal');
            eventDetailsModal.style.display = "none"; // Hide the modal
        }
        
        // Function to fetch and display events
        function displayAllEvents() {
            const currentUserId = auth.currentUser.uid; // Get current user's Firebase UID
            const futureEventList = document.getElementById('futureEventList'); // Reference to future events container
            const pastEventList = document.getElementById('pastEventList'); // Reference to past events container
            futureEventList.innerHTML = ''; // Clear future events list
            pastEventList.innerHTML = ''; // Clear past events list
        
            let allEvents = []; // Array to hold all events (yours + friends')
        
            // Fetch your events
            const yourEventsPromise = database.ref('users/' + currentUserId + '/events').once('value').then(snapshot => {
                const events = snapshot.val();
                if (events) {
                    const eventsArray = Object.keys(events);
                    eventsArray.forEach(eventId => {
                        const eventData = events[eventId];
                        allEvents.push({
                            title: eventData.title,
                            date: eventData.date,
                            time: eventData.time,
                            location: eventData.location || 'Not specified',
                            comment: eventData.comment || 'No comment',
                            category: eventData.category || 'Not specified',
                            createdBy: eventData.createdBy,
                            userId: "You",
                            visibleTo: eventData.visibleTo || [],
                            id: eventId
                        });
                    });
                }
            });
        
            // Fetch accepted friends
            const acceptedFriendsPromise = database.ref('users/' + currentUserId + '/friendRequests').once('value').then(snapshot => {
                const requests = snapshot.val();
                let friendIds = [];
        
                if (requests) {
                    const requestsArray = Object.keys(requests);
                    requestsArray.forEach(friendId => {
                        if (requests[friendId].status === 'accepted') {
                            friendIds.push(friendId);
                        }
                    });
                }
        
                const friendEventPromises = friendIds.map(friendId => {
                    return database.ref('users/' + friendId + '/events').once('value').then(eventSnapshot => {
                        const events = eventSnapshot.val();
                        if (events) {
                            const eventsArray = Object.keys(events);
                            const userIdPromises = eventsArray.map(eventId => {
                                return database.ref('users/' + friendId).once('value').then(userSnapshot => {
                                    const userData = userSnapshot.val();
                                    const friendUserId = userData ? userData.userId : friendId;
        
                                    const eventData = events[eventId];
                                    allEvents.push({
                                        title: eventData.title,
                                        date: eventData.date,
                                        time: eventData.time,
                                        location: eventData.location || 'Not specified',
                                        comment: eventData.comment || 'No comment',
                                        category: eventData.category || 'Not specified',
                                        createdBy: friendId,
                                        userId: friendUserId,
                                        visibleTo: eventData.visibleTo || [],
                                        id: eventId
                                    });
                                });
                            });
        
                            return Promise.all(userIdPromises);
                        }
                    });
                });
        
                return Promise.all(friendEventPromises);
            });
        
            Promise.all([yourEventsPromise, acceptedFriendsPromise]).then(() => {
                allEvents.sort((a, b) => {
                    const dateTimeA = new Date(`${a.date}T${a.time}:00`);
                    const dateTimeB = new Date(`${b.date}T${b.time}:00`);
                    return showFutureEvents ? dateTimeA - dateTimeB : dateTimeB - dateTimeA; // Sort correctly based on state
                });
        
                allEvents.forEach(event => {
                    const isVisible = event.createdBy === currentUserId || 
                                      (event.visibleTo && event.visibleTo.includes(currentUserId));

                        // Add this filtering logic
                    const eventDateTime = new Date(`${event.date}T${event.time}:00`);
                    const isFutureEvent = eventDateTime > new Date(); // Determine if it's a future event
                    
                    // Modify the visibility check to incorporate filtering
                    if (isVisible && (showFutureEvents ? isFutureEvent : !isFutureEvent)) {
                    // Create the event DOM element
                        const eventItem = document.createElement('div');
                        eventItem.classList.add('event-item');
                        eventItem.style.backgroundColor = '#FFFFFF'; // Set to white or desired neutral color

                        // Create a stadium for the event title
                        const titleStadium = document.createElement('div');
                        titleStadium.classList.add('stadium'); // Add class for styling
                        titleStadium.textContent = event.title; // Set text to the event title
                        eventItem.appendChild(titleStadium); // Append the title stadium to the event item

                        // Create a stadium for the event comment
                        const commentStadium = document.createElement('div');
                        commentStadium.classList.add('stadium', 'comment-stadium'); // Add class for styling
                        commentStadium.textContent = event.comment; // Set text to the event comment
                        eventItem.appendChild(commentStadium); // Append the comment stadium to the event item

                        // Create a flex container for stadiums
                        const stadiumContainer = document.createElement('div');
                        stadiumContainer.classList.add('stadium-container'); // Add a class for styling

                        // Create a container for user ID stadiums
                        const userIdContainer = document.createElement('div');
                        const participantList = document.createElement('div'); // Create participant list container
                        userIdContainer.classList.add('user-id-container');

                        // Create stadium for event creator's userId
                        const creatorStadium = document.createElement('div');
                        creatorStadium.classList.add('stadium');
                        creatorStadium.textContent = event.userId; // Set text to the event creator's userId
                        userIdContainer.appendChild(creatorStadium); // Append to the user ID container
                        
                        // Fetch participants for the event
                        database.ref(`users/${event.createdBy}/events/${event.id}/participants`).once('value').then(participantSnapshot => {
                            const participantUids = participantSnapshot.val() || []; // Get the list of UIDs

                            // Clear the participant list before adding new entries
                            participantList.innerHTML = ''; // Ensure this is cleared beforehand
                        
                            // Create stadiums for each participant
                            participantUids.forEach(uid => {
                                database.ref(`users/${uid}`).once('value').then(userSnapshot => {
                                    const userData = userSnapshot.val();
                                    const participantUserId = userData ? userData.userId : "Unknown User"; // Fallback if userId is not found
                                    
                                   // Create stadium for the participant
                                   // const participantStadium = document.createElement('div');
                                   // participantStadium.classList.add('stadium');
                                   // participantStadium.textContent = participantUserId; // Set text to participant's userId
                                   // stadiumContainer.appendChild(participantStadium); // Append participant stadium to the container
                                });
                            });

                        // Fetch participants for the event
                        database.ref(`users/${event.createdBy}/events/${event.id}/participants`).once('value').then(participantSnapshot => {
                            const participantUids = participantSnapshot.val() || []; // Get the list of UIDs
                            
                            // Create stadiums for each participant
                            participantUids.forEach(uid => {
                                database.ref(`users/${uid}`).once('value').then(userSnapshot => {
                                    const userData = userSnapshot.val();
                                    const participantUserId = userData ? userData.userId : "Unknown User"; // Fallback if userId is not found
                            
                                    // Create stadium for the participant
                                    const participantStadium = document.createElement('div');
                                    participantStadium.classList.add('stadium');
                                    participantStadium.textContent = participantUserId; // Set text to participant's userId
                                    userIdContainer.appendChild(participantStadium); // Append to the user ID container
                                });
                            });
                            
                            // Append the user ID container to the event item
                            eventItem.appendChild(userIdContainer);
                        });
                            
                            // Append the stadium container to the event item after all stadiums are created
                            eventItem.appendChild(stadiumContainer);

                            // Create a stadium for the event category
                            const categoryStadium = document.createElement('div');
                            categoryStadium.classList.add('stadium', 'category-tag'); // Use your category class
                            categoryStadium.textContent = event.category; // Set text to event category
                            categoryStadium.style.backgroundColor = categoryColors[event.category] || '#FFFFFF'; // Apply the color code
                            eventItem.appendChild(categoryStadium); // Append category stadium to the event item

                            // Create a container for the date, time, and location stadiums
                            const detailsContainer = document.createElement('div');
                            detailsContainer.style.display = 'flex'; // Use flexbox for horizontal layout
                            detailsContainer.style.alignItems = 'center'; // Center items vertically
                            detailsContainer.style.gap = '10px'; // Space between items
                            
                            // Create a stadium for the event date
                            const dateStadium = document.createElement('div');
                            dateStadium.classList.add('stadium');
                            dateStadium.textContent = formatDate(`${event.date}`); // Use the formatDate function
                            
                            // Create a stadium for the event time
                            const timeStadium = document.createElement('div');
                            timeStadium.classList.add('stadium');
                            timeStadium.textContent = formatTime(event.time); // Use the formatTime function
                            
                            // Create a stadium for the event location
                            const locationStadium = document.createElement('div');
                            locationStadium.classList.add('stadium', 'location-tag'); // Add a new class
                            locationStadium.textContent = event.location || 'Location not specified'; // Set text to event location
                            
                            // Append all stadiums to the details container
                            detailsContainer.appendChild(dateStadium);
                            detailsContainer.appendChild(timeStadium);
                            detailsContainer.appendChild(locationStadium);
                            
                            // Append the details container to the event item
                            eventItem.appendChild(detailsContainer);

                            
                        
                        });

                        // Existing button container setup
                        const buttonContainer = document.createElement('div');
                        buttonContainer.style.display = 'flex';
                        buttonContainer.style.flexDirection = 'column';
                        buttonContainer.style.gap = '10px';
                        
                        // Create the Delete button
                        const deleteButton = document.createElement('button');
                        deleteButton.textContent = 'Delete Event';
                        deleteButton.style.display = 'none'; // Initially hide the button
                        
                        // Check if the current user is the creator of the event
                        if (event.createdBy === currentUserId) {
                            deleteButton.style.display = 'block'; // Show the button if the user is the creator
                            deleteButton.onclick = function() {
                                deleteEvent(event.createdBy, event.id); // Call the deleteEvent function
                            };
                        }
                        
                        // Append the delete button to the button container
                        buttonContainer.appendChild(deleteButton);
                        
                        // Add the join button if applicable
                        if (event.createdBy !== currentUserId) {
                            const joinButton = document.createElement('button');
                            joinButton.classList.add('join-btn');
                            joinButton.textContent = 'Join';
                            joinButton.style.marginLeft = 'auto';
                        
                            database.ref(`users/${event.createdBy}/events/${event.id}/participants`).once('value').then(snapshot => {
                                const participants = snapshot.val() || [];
                                const isParticipant = participants.includes(currentUserId);
                                joinButton.textContent = isParticipant ? 'Leave Event' : 'Join!';
                                joinButton.onclick = function () {
                                    toggleParticipation(event.createdBy, event.id, currentUserId, joinButton);
                                };

                                // Set button color based on text
                                joinButton.style.backgroundColor = isParticipant ? 'red' : 'green'; // Red if leaving, green if joining
                                joinButton.onclick = function() {
                                    toggleParticipation(event.createdBy, event.id, currentUserId, joinButton);
                                    
                                    // Update the button color based on action
                                    if (joinButton.textContent === 'Join!') {
                                        joinButton.style.backgroundColor = 'green'; // Green when joining
                                    } else {
                                        joinButton.style.backgroundColor = 'red'; // Red when leaving
                                    }
                                };
                            });
                        
                            buttonContainer.appendChild(joinButton); // Add the join button if applicable
                        }
                        
                        // Append the button container to the event item
                        eventItem.appendChild(buttonContainer);
        
                        // const eventOwner = (event.createdBy === currentUserId) ? '(Your Event)' : `(Created by: ${event.userId})`;
        
                        const eventContent = document.createElement('div');
                        // eventContent.classList.add('event-content');
                        // eventContent.textContent = `${event.title} - ${event.date} at ${event.time} ${eventOwner}
                           //  | Comment: ${event.comment || 'No comment'} 
                           // | Location: ${event.location || 'Not specified'} 
                           // | Category: ${event.category || 'Not specified'}`;

                        // Append to the appropriate list
                        if (isFutureEvent) {
                            futureEventList.appendChild(eventItem); // Add to future events list
                        } else {
                            pastEventList.appendChild(eventItem); // Add to past events list
                        }

                        // Add this code right after creating the eventContent
                        // const participantList = document.createElement('div');
                        // participantList.classList.add('participant-list'); // Add a class for styling
                        // eventItem.appendChild(participantList); // Append the participant list to the event item
                        
                        // Fetch participants for the event
                        database.ref(`users/${event.createdBy}/events/${event.id}/participants`).once('value').then(participantSnapshot => {
                            const participantUids = participantSnapshot.val() || []; // Get the list of UIDs
                        
                            if (participantUids.length === 0) {
                                // participantList.textContent = "No participants yet."; // Message if no participants
                            } else {
                                participantUids.forEach(uid => {
                                    database.ref(`users/${uid}`).once('value').then(userSnapshot => {
                                        const userData = userSnapshot.val();
                                        const userId = userData ? userData.userId : "Unknown User"; // Fallback
                                        const participantItem = document.createElement('div');
                                        // participantItem.textContent = userId; // Display the userId
                                        // participantList.appendChild(participantItem); // Add to the participant list
                                    }).catch(error => {
                                        console.error("Error fetching userId for UID:", uid, error);
                                    });
                                });
                            }
                        }).catch(error => {
                            console.error("Error fetching participants:", error);
                            participantList.textContent = "Unable to load participants."; // Display error message
                        });

                        participantList.classList.add('participant-list');
                        eventItem.appendChild(participantList); // Append the participant list to the event item
        
                        // Create the "Pictures" button
                        const picturesButton = document.createElement('button');
                        picturesButton.textContent = 'Pictures';
                        picturesButton.onclick = function () {
                            openEventDetails(event); // Open the event details modal
                        };

                        // Hide the button
                        picturesButton.style.display = 'none'; // This hides the button
        
                        buttonContainer.appendChild(picturesButton); // Add pictures button
                        eventItem.appendChild(eventContent);
                        // Create a container for the upload section
                        const uploadContainer = document.createElement('div');
                        uploadContainer.classList.add('upload-container'); // Add the class

                        // Create a single "Upload Picture" button
                        const singleUploadButton = document.createElement('button');
                        singleUploadButton.textContent = 'Add Picture';
                        singleUploadButton.classList.add('single-upload-button'); // Add the class

                        // Hide the button for future events
                        if (isFutureEvent) {
                            singleUploadButton.style.display = 'none'; // Hide button for future events
                        } else {
                            singleUploadButton.style.display = 'block'; // Show button for past events
                        }

                        // Append the button to the upload container
                        uploadContainer.appendChild(singleUploadButton);
                        
                        // Append the upload container to the event item
                        eventItem.appendChild(uploadContainer);
                        
                        singleUploadButton.onclick = function() {
                            const fileInput = document.createElement('input');
                            fileInput.type = 'file';
                            fileInput.accept = 'image/*'; // Accept only image files
                        
                            fileInput.onchange = function() {
                                const file = fileInput.files[0]; // Get the selected file
                        
                                if (!file) {
                                    alert("Please select a file to upload.");
                                    return;
                                }
                        
                                const imageUrl = URL.createObjectURL(file);
                                const cropImageElement = document.getElementById('cropperImage');
                                cropImageElement.src = imageUrl; // Set the source for cropping
                        
                                const modal = document.getElementById('cropModal');
                                modal.style.display = 'block'; // Show the crop modal
                        
                                const cropper = new Cropper(cropImageElement, {
                                    aspectRatio: 1,
                                    viewMode: 1,
                                });
                        
                                document.getElementById('cropBtn').onclick = function () {
                                    const canvas = cropper.getCroppedCanvas({
                                        width: 1080,
                                        height: 1080,
                                    });
                                    canvas.toBlob(function(blob) {
                                        uploadCroppedImage(blob); // Call to upload function
                                    });
                        
                                    modal.style.display = 'none'; // Hide the modal after cropping
                                };
                        
                                document.getElementById('cancelBtn').onclick = function () {
                                    modal.style.display = 'none'; // Hide the modal if cancelled
                                };
                            };
                        
                            fileInput.click(); // Trigger the file input dialog
                        };
                        
                        function uploadCroppedImage(blob) {
                            const currentUser = auth.currentUser;
                            if (currentUser) {
                                const userId = currentUser.uid; // Get the logged-in user's UID
                                const eventId = event.id; // Ensure this is set correctly
                        
                                // Create a storage reference
                                const storageRef = storage.ref(`event_pictures/${eventId}/cropped_${Date.now()}.jpg`);
                        
                                const uploadTask = storageRef.put(blob);
                        
                                uploadTask.on(
                                    'state_changed',
                                    (snapshot) => {
                                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                                        console.log(`Upload is ${progress.toFixed(0)}% done.`); // Log upload progress
                                    },
                                    (error) => {
                                        console.error("Error uploading cropped image:", error);
                                        alert(`Error: ${error.message}`);
                                    },
                                    () => {
                                        uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
                                            // Save the download URL to the database under the event ID
                                            database.ref(`events/${eventId}/pictures`).push({
                                                url: downloadURL,
                                                uploadedAt: new Date().toISOString()
                                            }).then(() => {
                                                alert("Picture uploaded successfully!");
                                            }).catch((error) => {
                                                console.error("Error saving picture URL to database:", error);
                                                alert(`Error: ${error.message}`);
                                            });
                                        });
                                    }
                                );
                            } else {
                                alert("User not authenticated.");
                            }
                        }

                        // Append the new button to the button container
                        buttonContainer.appendChild(singleUploadButton);
        
                        // Create picture carousel container
                        const picturesContainer = document.createElement('div');
                        const prevButton = document.createElement('button');
                        prevButton.textContent = '<';
                        prevButton.style.position = 'absolute';
                        prevButton.style.left = '10px'; // Change this value to adjust
                        prevButton.style.top = '50%'; // Center vertically
                        prevButton.style.transform = 'translateY(-50%)'; // Adjust for centering
                        const nextButton = document.createElement('button');
                        nextButton.textContent = '>';
                        nextButton.style.position = 'absolute';
                        nextButton.style.right = '10px'; // Change this value to adjust
                        nextButton.style.top = '50%'; // Center vertically
                        nextButton.style.transform = 'translateY(-50%)'; // Adjust for centering
                        let currentIndex = 0;
                        let images = [];
        
                        picturesContainer.classList.add('event-pictures'); // Optional class for styling
                        picturesContainer.style.display = 'flex';
                        picturesContainer.style.flexDirection = 'column';
                        picturesContainer.style.alignItems = 'center';
        
                        // Fetch pictures and set up the carousel
                        database.ref(`events/${event.id}/pictures`).once('value').then(snapshot => {
                            snapshot.forEach(childSnapshot => {
                                const pictureData = childSnapshot.val();
                                const img = document.createElement('img');
                                img.src = pictureData.url;
                                img.alt = "Event Picture";
                                img.style.display = 'none'; // Start with images hidden
                                img.style.width = "100%"; // Set width to 100% for full width
                                img.style.height = "auto"; // Maintain aspect ratio
                                img.style.margin = "5px"; // Add margin
                                picturesContainer.appendChild(img); // Add to the pictures container
                                images.push(img); // Store image elements for navigation
                            });
        
                            // Show the first image if there are any
                            if (images.length > 0) {
                                images[0].style.display = 'block';
                                // Only show buttons if there are more than one image
                                if (images.length > 1) {
                                    prevButton.style.display = 'block';
                                    nextButton.style.display = 'block';
                                } else {
                                    prevButton.style.display = 'none';
                                    nextButton.style.display = 'none';
                                }
                            } else {
                                prevButton.style.display = 'none';
                                nextButton.style.display = 'none'; // Hide buttons if no images
                            }
                        });
        
                        // Previous button functionality
                        prevButton.textContent = '<';
                        prevButton.onclick = function() {
                            if (images.length > 0) {
                                images[currentIndex].style.display = 'none'; // Hide current image
                                currentIndex = (currentIndex - 1 + images.length) % images.length; // Move to previous image
                                images[currentIndex].style.display = 'block'; // Show new current image
                            }
                        };
        
                        // Next button functionality
                        nextButton.textContent = '>';
                        nextButton.onclick = function() {
                            if (images.length > 0) {
                                images[currentIndex].style.display = 'none'; // Hide current image
                                currentIndex = (currentIndex + 1) % images.length; // Move to next image
                                images[currentIndex].style.display = 'block'; // Show new current image
                            }
                        };
        
                        // Append pictures container and navigation buttons
                        eventItem.appendChild(picturesContainer); // Append pictures container
                        eventItem.appendChild(prevButton); // Append previous button
                        eventItem.appendChild(nextButton); // Append next button
                    }
                });

                // Scroll to the soonest future event
                const soonestFutureEvent = allEvents.find(event => {
                    const eventDateTime = new Date(`${event.date}T${event.time}:00`);
                    return eventDateTime > new Date(); // Find the first future event
                });
                
                if (soonestFutureEvent) {
                    const futureEventList = document.getElementById('futureEventList');
                    const eventItems = futureEventList.getElementsByClassName('event-item');
                    
                    // Find the matching DOM element for the soonest future event
                    for (let eventItem of eventItems) {
                        if (eventItem.textContent.includes(soonestFutureEvent.title)) {
                            // Scroll the event-box container to the soonest future event
                            const eventBox = document.querySelector('.event-box');
                            eventBox.scrollTop = eventItem.offsetTop - eventBox.offsetHeight / 2;
                            break;
                        }
                    }
                }
            }).catch(error => {
                console.error("Error fetching events:", error);
            });
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const options = { day: 'numeric', month: 'long', year: 'numeric' };
            const formattedDate = date.toLocaleDateString('en-US', options);
            
            // Add the ordinal suffix (st, nd, rd, th) to the day
            const day = date.getDate();
            const suffix = day % 10 === 1 && day !== 11 ? 'st' :
                           day % 10 === 2 && day !== 12 ? 'nd' :
                           day % 10 === 3 && day !== 13 ? 'rd' : 'th';
            
            return formattedDate.replace(/(\d+)/, `${day}${suffix}`);
        }

        function formatTime(timeString) {
            const [hours, minutes] = timeString.split(':').map(Number);
            const period = hours >= 12 ? 'p.m.' : 'a.m.';
            const formattedHour = hours % 12 || 12; // Convert 0 to 12 for 12 AM
            return `${formattedHour}:${minutes.toString().padStart(2, '0')} ${period}`;
        }
        
        // Log out function
        document.getElementById('logoutBtn').onclick = function() {
            auth.signOut().then(() => {
                window.location.href = 'index.html';
            }).catch((error) => {
                console.error("Error logging out:", error);
            });
        };

        // Create event button functionality
        // Create event button functionality
        document.getElementById('createEventBtn').onclick = function() {
            createEvent(); // Call the createEvent function
        };

        // Event modal functionality
        document.getElementById("submitEventBtn").onclick = submitEvent;
        document.getElementsByClassName("close")[0].onclick = closeModal;

        // Fetch users and requests when the page loads
        auth.onAuthStateChanged(user => {
            if (user) {
                // Fetch userId from the database using UID
                database.ref('users/' + user.uid).once('value').then(snapshot => {
                    const userData = snapshot.val();
                    if (userData) {
                        const userId = userData.userId; // Get userId from database
                        document.getElementById('welcomeHeader').textContent = `Welcome, ${userId}!`; // Display welcome message
                    }
                });
        
                displayUsers();
                displayPendingRequests(); // Fetch and display pending friend requests
                displayAcceptedFriends(); // Fetch and display accepted friends
                displayAllEvents(); // Fetch and display friends' and user's events
            } else {
                window.location.href = 'index.html'; // Redirect if not logged in
            }
        });

        // Function to toggle the collapsible content
        function toggleCollapsible() {
            const content = document.querySelector('.collapsible-content');
            if (content.style.display === "block") {
                content.style.display = "none"; // Hide the content
            } else {
                content.style.display = "block"; // Show the content
            }
        }

        document.getElementById('toggleMenuBtn').onclick = function() {
            const sidebar = document.getElementById('sidebar');
            sidebar.style.display = sidebar.style.display === 'none' ? 'block' : 'none'; // Toggle visibility
            if (sidebar.style.display === 'block') {
                sidebar.style.left = '0'; // Ensure it's visible
            } else {
                sidebar.style.left = '-250px'; // Hide it off-screen
            }
        };

        document.getElementById('toggleEventsBtn').onclick = function() {
            showFutureEvents = !showFutureEvents; // Toggle the state
            this.textContent = showFutureEvents ? 'Show Past Events' : 'Show Future Events'; // Update button text
            displayAllEvents(); // Refresh the events display
        };

        // Initially hide the sidebar
        document.addEventListener('DOMContentLoaded', function() {
            const sidebar = document.getElementById('sidebar');
            sidebar.style.display = 'none'; // Start with the sidebar hidden

                // Hide modals initially
                const eventModal = document.getElementById("eventModal");
                const eventDetailsModal = document.getElementById("eventDetailsModal");
                eventModal.style.display = "none"; // Hide event creation modal
                eventDetailsModal.style.display = "none"; // Hide event details modal
        });

        // Event listener for clicks outside the modal content
        window.onclick = function(event) {
            const modal = document.getElementById("eventModal");
            const modalContent = document.querySelector('.modal-content');
        
            // Check if the click was outside the modal content
            if (event.target === modal) {
                closeModal(); // Close the modal if clicked outside
            }
        };

        // Event modal functionality
        document.getElementById("submitEventBtn").onclick = submitEvent;
        document.getElementsByClassName("close")[0].onclick = closeModal;


        document.getElementById('toggleMessageBtn').onclick = function() {
            const messageDiv = document.getElementById('toggleMessage');
            messageDiv.style.display = messageDiv.style.display === 'none' ? 'block' : 'none'; // Toggle display
        };

        // Upload picture functionality
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('uploadPictureBtn').onclick = function () {
                const fileInput = document.getElementById('uploadPictureInput');
                const file = fileInput.files[0]; // Get the selected file
            
                if (!file) {
                    document.getElementById('uploadStatus').textContent = "Please select a file.";
                    return;
                }
            
                const imageUrl = URL.createObjectURL(file);
                const cropImageElement = document.getElementById('cropperImage');
                cropImageElement.src = imageUrl; // Set the source for cropping
            
                const modal = document.getElementById('cropModal');
                modal.style.display = 'block'; // Show the modal
    
                const cropper = new Cropper(cropImageElement, {
                    aspectRatio: 1,
                    viewMode: 1,
                });
            
                document.getElementById('cropBtn').onclick = function () {
                    const canvas = cropper.getCroppedCanvas({
                        width: 1080,
                        height: 1080,
                    });
                    canvas.toBlob(function(blob) {
                        uploadCroppedImage(blob); // Call to upload function
                    });
            
                    modal.style.display = 'none'; // Hide the modal after cropping
                };
            
                document.getElementById('cancelBtn').onclick = function () {
                    modal.style.display = 'none'; // Hide the modal if cancelled
                };
            };
        });
    </script>

</body>
</html>
