<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>You are Connected</title>
    <script src="https://www.gstatic.com/firebasejs/9.9.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.9.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.9.0/firebase-database-compat.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: auto;
            margin: 0;
            text-align: center;
        }
        button {
            padding: 10px 15px;
            font-size: 16px;
            margin-top: 20px;
        }
        .user-list, .request-list, .accepted-list {
            margin-top: 20px;
            width: 100%;
            max-width: 400px;
            text-align: left;
        }
        .user-item, .request-item, .accepted-item {
            padding: 5px;
            border: 1px solid #ccc;
            margin: 5px 0;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
    </style>
</head>
<body>
    <h2>You are connected</h2>
    <button id="logoutBtn">Log Out</button>

    <div class="user-list" id="userList"></div>
    <h3>Pending Friend Requests</h3>
    <div class="request-list" id="requestList"></div>

    <h3>Accepted Friends</h3>
    <div class="accepted-list" id="acceptedList"></div>

    <script>
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBB61hJK8iHNAXz2q5u8ghGqIFMyJh-Nho",
            authDomain: "aperosocial-d53c7.firebaseapp.com",
            databaseURL: "https://aperosocial-d53c7-default-rtdb.firebaseio.com",
            projectId: "aperosocial-d53c7",
            storageBucket: "aperosocial-d53c7.appspot.com",
            messagingSenderId: "954205055992",
            appId: "1:954205055992:web:c2ebebe1c0ac210163440d"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // Function to fetch and display users
        function displayUsers() {
            const currentUserId = auth.currentUser.uid; // Get current user's Firebase UID
            
            database.ref('users').once('value').then(snapshot => {
                const userList = document.getElementById('userList');
                userList.innerHTML = ''; // Clear previous list

                // Display current user at the top
                const currentUserData = snapshot.child(currentUserId).val();
                if (currentUserData) {
                    const currentUserItem = document.createElement('div');
                    currentUserItem.classList.add('user-item');
                    currentUserItem.textContent = currentUserData.userId; // Display current user's ID
                    userList.appendChild(currentUserItem); // Add to the list
                }

                snapshot.forEach(childSnapshot => {
                    const userData = childSnapshot.val();
                    const userId = userData.userId;
                    const targetUserId = childSnapshot.key; // Get the UID

                    // Skip adding the current user again
                    if (userId === currentUserData?.userId) return;

                    // Create a user item
                    const userItem = document.createElement('div');
                    userItem.classList.add('user-item');
                    userItem.textContent = userId;

                    // Create the button
                    const actionButton = document.createElement('button');

                    // Check for incoming requests
                    database.ref('users/' + currentUserId + '/friendRequests/' + targetUserId).once('value').then(friendSnapshot => {
                        if (friendSnapshot.exists()) {
                            // If the logged-in user has received a request
                            if (friendSnapshot.val().status === 'pending') {
                                actionButton.textContent = 'Pending';
                                actionButton.disabled = true; // Disable button
                            } else if (friendSnapshot.val().status === 'accepted') {
                                actionButton.textContent = 'Friends';
                                actionButton.disabled = true; // Disable button
                            }
                        } 

                        // Check for outgoing requests
                        database.ref('users/' + targetUserId + '/friendRequests/' + currentUserId).once('value').then(requestSnapshot => {
                            if (requestSnapshot.exists()) {
                                // If the logged-in user has sent a request
                                if (requestSnapshot.val().status === 'pending') {
                                    actionButton.textContent = 'Pending';
                                    actionButton.disabled = true; // Disable button
                                }
                            } else {
                                // If there are no requests, show the + button
                                actionButton.textContent = '+';
                                actionButton.onclick = function() {
                                    sendFriendRequest(targetUserId, actionButton); // Pass user UID and button
                                };
                            }
                        });
                    });

                    // Append button to user item
                    userItem.appendChild(actionButton);
                    
                    // Append to the user list
                    userList.appendChild(userItem);
                });
            }).catch(error => {
                console.error("Error fetching users:", error);
            });
        }

        // Function to send a friend request
        function sendFriendRequest(targetUserId, button) {
            const currentUserId = auth.currentUser.uid; // Get current user's Firebase UID
            
            // Update the database to add the friend request under the target user's record
            database.ref('users/' + targetUserId + '/friendRequests/' + currentUserId).set({
                requestingUserId: currentUserId,
                status: 'pending'
            }).then(() => {
                console.log("Friend request sent to " + targetUserId);
                button.textContent = 'Pending'; // Change button text to "Pending"
                button.disabled = true; // Disable the button
            }).catch(error => {
                console.error("Error sending friend request:", error);
            });
        }

        // Function to fetch and display pending friend requests
        function displayPendingRequests() {
            const currentUserId = auth.currentUser.uid; // Get current user's Firebase UID
            
            database.ref('users/' + currentUserId + '/friendRequests').once('value').then(snapshot => {
                const requestList = document.getElementById('requestList');
                requestList.innerHTML = ''; // Clear previous list

                const pendingRequests = snapshot.val();
                if (pendingRequests) {
                    const requestsArray = Object.keys(pendingRequests);
                    requestsArray.forEach(requesterId => {
                        // Check if the request is still pending
                        if (pendingRequests[requesterId].status === 'pending') {
                            // Fetch userId of the requester
                            database.ref('users/' + requesterId).once('value').then(userSnapshot => {
                                const requesterData = userSnapshot.val();
                                if (requesterData) {
                                    const requestItem = document.createElement('div');
                                    requestItem.classList.add('request-item');
                                    requestItem.textContent = requesterData.userId; // Display the userId of the requester
                                    
                                    // Create a tick button for the recipient
                                    const acceptButton = document.createElement('button');
                                    acceptButton.textContent = 'âœ“';
                                    acceptButton.onclick = function() {
                                        acceptFriendRequest(requesterId); // Pass the requester UID
                                    };

                                    // Append tick button to request item
                                    requestItem.appendChild(acceptButton);
                                    requestList.appendChild(requestItem); // Add to the list
                                }
                            });
                        }
                    });
                }
            }).catch(error => {
                console.error("Error fetching friend requests:", error);
            });
        }

        // Function to fetch and display accepted friends
        function displayAcceptedFriends() {
            const currentUserId = auth.currentUser.uid; // Get current user's Firebase UID
            
            database.ref('users/' + currentUserId + '/friendRequests').once('value').then(snapshot => {
                const acceptedList = document.getElementById('acceptedList');
                acceptedList.innerHTML = ''; // Clear previous list

                const requests = snapshot.val();
                if (requests) {
                    const requestsArray = Object.keys(requests);
                    requestsArray.forEach(requesterId => {
                        if (requests[requesterId].status === 'accepted') {
                            // Fetch userId of the accepted requester
                            database.ref('users/' + requesterId).once('value').then(userSnapshot => {
                                const requesterData = userSnapshot.val();
                                if (requesterData) {
                                    const acceptedItem = document.createElement('div');
                                    acceptedItem.classList.add('accepted-item');
                                    acceptedItem.textContent = requesterData.userId; // Display the userId of the accepted friend
                                    acceptedList.appendChild(acceptedItem); // Add to the list
                                }
                            });
                        }
                    });
                }
            }).catch(error => {
                console.error("Error fetching accepted friends:", error);
            });
        }

        // Function to accept a friend request
        function acceptFriendRequest(requesterId) {
            const currentUserId = auth.currentUser.uid; // Get current user's Firebase UID
            
            // Update the database to change the status of the friend request
            database.ref('users/' + currentUserId + '/friendRequests/' + requesterId).update({
                status: 'accepted'
            }).then(() => {
                console.log("Friend request from " + requesterId + " accepted.");
                // Also update the sender's request status to accepted
                database.ref('users/' + requesterId + '/friendRequests/' + currentUserId).set({
                    requestingUserId: currentUserId,
                    status: 'accepted'
                }).then(() => {
                    displayPendingRequests(); // Refresh the pending requests display
                    displayAcceptedFriends(); // Refresh the accepted friends display
                });
            }).catch(error => {
                console.error("Error accepting friend request:", error);
            });
        }

        // Log out function
        document.getElementById('logoutBtn').onclick = function() {
            auth.signOut().then(() => {
                window.location.href = 'index.html';
            }).catch((error) => {
                console.error("Error logging out:", error);
            });
        };

        // Fetch users and requests when the page loads
        auth.onAuthStateChanged(user => {
            if (user) {
                displayUsers();
                displayPendingRequests(); // Fetch and display pending friend requests
                displayAcceptedFriends(); // Fetch and display accepted friends
            } else {
                window.location.href = 'index.html'; // Redirect if not logged in
            }
        });
    </script>
</body>
</html>
