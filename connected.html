<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>You are Connected</title>
    <link rel="stylesheet" href="styles.css"> <!-- Link to external CSS -->
    <script src="https://www.gstatic.com/firebasejs/9.9.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.9.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.9.0/firebase-database-compat.js"></script>
</head>
<body>
    <div class="sidebar">
        <h2>You are connected</h2>
        <button id="logoutBtn">Log Out</button>
        <button id="createEventBtn">Create Event</button>

        <h3>All Users</h3>
        <div class="user-list" id="userList"></div>

        <h3>Pending Friend Requests</h3>
        <div class="request-list" id="requestList"></div>

        <h3>Accepted Friends</h3>
        <div class="accepted-list" id="acceptedList"></div>
    </div>

    <div class="main-content">
        <h3>Your Events</h3>
        <div class="event-list" id="eventList"></div>

        <h3>Friends' Events</h3>
        <div class="friends-event-list" id="friendsEventList"></div>
    </div>

    <!-- Modal for Event Creation -->
    <div id="eventModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3>Create Event</h3>
            <label for="eventTitle">Event Title:</label>
            <input type="text" id="eventTitle" required>
            <br>
            <label for="eventDate">Event Date:</label>
            <input type="date" id="eventDate" required>
            <br>
            <label for="eventTime">Event Time:</label>
            <input type="time" id="eventTime" required>
            <br>
            <button id="submitEventBtn">Create Event</button>
        </div>
    </div>

    <script>
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBB61hJK8iHNAXz2q5u8ghGqIFMyJh-Nho",
            authDomain: "aperosocial-d53c7.firebaseapp.com",
            databaseURL: "https://aperosocial-d53c7-default-rtdb.firebaseio.com",
            projectId: "aperosocial-d53c7",
            storageBucket: "aperosocial-d53c7.appspot.com",
            messagingSenderId: "954205055992",
            appId: "1:954205055992:web:c2ebebe1c0ac210163440d"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // Function to fetch and display users
        function displayUsers() {
            const currentUserId = auth.currentUser.uid; // Get current user's Firebase UID
            
            database.ref('users').once('value').then(snapshot => {
                const userList = document.getElementById('userList');
                userList.innerHTML = ''; // Clear previous list

                // Display current user at the top
                const currentUserData = snapshot.child(currentUserId).val();
                if (currentUserData) {
                    const currentUserItem = document.createElement('div');
                    currentUserItem.classList.add('user-item');
                    currentUserItem.textContent = currentUserData.userId; // Display current user's ID
                    userList.appendChild(currentUserItem); // Add to the list
                }

                snapshot.forEach(childSnapshot => {
                    const userData = childSnapshot.val();
                    const userId = userData.userId;
                    const targetUserId = childSnapshot.key; // Get the UID

                    // Skip adding the current user again
                    if (userId === currentUserData?.userId) return;

                    // Create a user item
                    const userItem = document.createElement('div');
                    userItem.classList.add('user-item');
                    userItem.textContent = userId;

                    // Create the button
                    const actionButton = document.createElement('button');

                    // Check for incoming requests
                    database.ref('users/' + currentUserId + '/friendRequests/' + targetUserId).once('value').then(friendSnapshot => {
                        if (friendSnapshot.exists()) {
                            // If the logged-in user has received a request
                            if (friendSnapshot.val().status === 'pending') {
                                actionButton.textContent = 'Pending';
                                actionButton.disabled = true; // Disable button
                            } else if (friendSnapshot.val().status === 'accepted') {
                                actionButton.textContent = 'Friends';
                                actionButton.disabled = true; // Disable button
                            }
                        } 

                        // Check for outgoing requests
                        database.ref('users/' + targetUserId + '/friendRequests/' + currentUserId).once('value').then(requestSnapshot => {
                            if (requestSnapshot.exists()) {
                                // If the logged-in user has sent a request
                                if (requestSnapshot.val().status === 'pending') {
                                    actionButton.textContent = 'Pending';
                                    actionButton.disabled = true; // Disable button
                                }
                            } else {
                                // If there are no requests, show the + button
                                actionButton.textContent = '+';
                                actionButton.onclick = function() {
                                    sendFriendRequest(targetUserId, actionButton); // Pass user UID and button
                                };
                            }
                        });
                    });

                    // Append button to user item
                    userItem.appendChild(actionButton);
                    
                    // Append to the user list
                    userList.appendChild(userItem);
                });
            }).catch(error => {
                console.error("Error fetching users:", error);
            });
        }

        // Function to send a friend request
        function sendFriendRequest(targetUserId, button) {
            const currentUserId = auth.currentUser.uid; // Get current user's Firebase UID
            
            // Update the database to add the friend request under the target user's record
            database.ref('users/' + targetUserId + '/friendRequests/' + currentUserId).set({
                requestingUserId: currentUserId,
                status: 'pending'
            }).then(() => {
                console.log("Friend request sent to " + targetUserId);
                button.textContent = 'Pending'; // Change button text to "Pending"
                button.disabled = true; // Disable the button
            }).catch(error => {
                console.error("Error sending friend request:", error);
            });
        }

        // Function to fetch and display pending friend requests
        function displayPendingRequests() {
            const currentUserId = auth.currentUser.uid; // Get current user's Firebase UID
            
            database.ref('users/' + currentUserId + '/friendRequests').once('value').then(snapshot => {
                const requestList = document.getElementById('requestList');
                requestList.innerHTML = ''; // Clear previous list

                const pendingRequests = snapshot.val();
                if (pendingRequests) {
                    const requestsArray = Object.keys(pendingRequests);
                    requestsArray.forEach(requesterId => {
                        // Check if the request is still pending
                        if (pendingRequests[requesterId].status === 'pending') {
                            // Fetch userId of the requester
                            database.ref('users/' + requesterId).once('value').then(userSnapshot => {
                                const requesterData = userSnapshot.val();
                                if (requesterData) {
                                    const requestItem = document.createElement('div');
                                    requestItem.classList.add('request-item');
                                    requestItem.textContent = requesterData.userId; // Display the userId of the requester
                                    
                                    // Create a tick button for the recipient
                                    const acceptButton = document.createElement('button');
                                    acceptButton.textContent = 'âœ“';
                                    acceptButton.onclick = function() {
                                        acceptFriendRequest(requesterId); // Pass the requester UID
                                    };

                                    // Append tick button to request item
                                    requestItem.appendChild(acceptButton);
                                    requestList.appendChild(requestItem); // Add to the list
                                }
                            });
                        }
                    });
                }
            }).catch(error => {
                console.error("Error fetching friend requests:", error);
            });
        }

        // Function to fetch and display accepted friends
        function displayAcceptedFriends() {
            const currentUserId = auth.currentUser.uid; // Get current user's Firebase UID
            
            database.ref('users/' + currentUserId + '/friendRequests').once('value').then(snapshot => {
                const acceptedList = document.getElementById('acceptedList');
                acceptedList.innerHTML = ''; // Clear previous list

                const requests = snapshot.val();
                if (requests) {
                    const requestsArray = Object.keys(requests);
                    requestsArray.forEach(requesterId => {
                        if (requests[requesterId].status === 'accepted') {
                            // Fetch userId of the accepted requester
                            database.ref('users/' + requesterId).once('value').then(userSnapshot => {
                                const requesterData = userSnapshot.val();
                                if (requesterData) {
                                    const acceptedItem = document.createElement('div');
                                    acceptedItem.classList.add('accepted-item');
                                    acceptedItem.textContent = requesterData.userId; // Display the userId of the accepted friend
                                    acceptedList.appendChild(acceptedItem); // Add to the list
                                }
                            });
                        }
                    });
                }
            }).catch(error => {
                console.error("Error fetching accepted friends:", error);
            });
        }

        // Function to accept a friend request
        function acceptFriendRequest(requesterId) {
            const currentUserId = auth.currentUser.uid; // Get current user's Firebase UID
            
            // Update the database to change the status of the friend request
            database.ref('users/' + currentUserId + '/friendRequests/' + requesterId).update({
                status: 'accepted'
            }).then(() => {
                console.log("Friend request from " + requesterId + " accepted.");
                // Also update the sender's request status to accepted
                database.ref('users/' + requesterId + '/friendRequests/' + currentUserId).set({
                    requestingUserId: currentUserId,
                    status: 'accepted'
                }).then(() => {
                    displayPendingRequests(); // Refresh the pending requests display
                    displayAcceptedFriends(); // Refresh the accepted friends display
                    displayFriendsEvents(); // Refresh friends' events display
                });
            }).catch(error => {
                console.error("Error accepting friend request:", error);
            });
        }

        // Function to create an event
        function createEvent() {
            const modal = document.getElementById("eventModal");
            modal.style.display = "block"; // Show the modal
        }

        function submitEvent() {
            const title = document.getElementById("eventTitle").value;
            const date = document.getElementById("eventDate").value;
            const time = document.getElementById("eventTime").value;
        
            if (title && date && time) {
                const currentUserId = auth.currentUser.uid; // Get current user's Firebase UID
                const eventKey = database.ref('users/' + currentUserId + '/events').push().key; // Create a unique key for the event
        
                database.ref('users/' + currentUserId + '/events/' + eventKey).set({
                    title: title,
                    date: date,
                    time: time,
                    createdBy: currentUserId // Store the creator's user ID
                }).then(() => {
                    alert("Event created successfully!");
                    displayEvents(); // Refresh the events display
                    displayFriendsEvents(); // Refresh friends' events display
                    closeModal(); // Close the modal
                }).catch(error => {
                    console.error("Error creating event:", error);
                });
            } else {
                alert("All fields are required!");
            }
        }

        // Function to close the modal
        function closeModal() {
            const modal = document.getElementById("eventModal");
            modal.style.display = "none"; // Hide the modal
            document.getElementById("eventTitle").value = '';
            document.getElementById("eventDate").value = '';
            document.getElementById("eventTime").value = '';
        }

        // Function to fetch and display events
        function displayEvents() {
            const currentUserId = auth.currentUser.uid; // Get current user's Firebase UID
            
            database.ref('users/' + currentUserId + '/events').once('value').then(snapshot => {
                const eventList = document.getElementById('eventList');
                eventList.innerHTML = ''; // Clear previous list

                const events = snapshot.val();
                if (events) {
                    const eventsArray = Object.keys(events);
                    eventsArray.forEach(eventId => {
                        const eventData = events[eventId];
                        const eventItem = document.createElement('div');
                        eventItem.classList.add('event-item');
                        eventItem.textContent = `${eventData.title} - ${eventData.date} at ${eventData.time}`; // Display event details
                        eventList.appendChild(eventItem); // Add to the list
                    });
                }
            }).catch(error => {
                console.error("Error fetching events:", error);
            });
        }


        // Function to fetch and display friends' events
        function displayFriendsEvents() {
            const currentUserId = auth.currentUser.uid; // Get current user's Firebase UID
            const friendsEventList = document.getElementById('friendsEventList');
            friendsEventList.innerHTML = ''; // Clear previous list
        
            // Array to hold all events
            let allEvents = [];
        
            // Fetch accepted friends
            database.ref('users/' + currentUserId + '/friendRequests').once('value').then(snapshot => {
                const requests = snapshot.val();
                if (requests) {
                    const requestsArray = Object.keys(requests);
                    let eventPromises = []; // Array to hold promises
        
                    requestsArray.forEach(friendId => {
                        if (requests[friendId].status === 'accepted') {
                            // Fetch friend's events
                            eventPromises.push(database.ref('users/' + friendId + '/events').once('value').then(eventSnapshot => {
                                const events = eventSnapshot.val();
                                if (events) {
                                    const eventsArray = Object.keys(events);
                                    eventsArray.forEach(eventId => {
                                        const eventData = events[eventId];
                                        // Push event data along with friend ID to the allEvents array
                                        allEvents.push({
                                            title: eventData.title,
                                            date: eventData.date,
                                            time: eventData.time,
                                            createdBy: eventData.createdBy,
                                            friendId: friendId
                                        });
                                    });
                                }
                            }));
                        }
                    });
        
                    // Wait for all eventPromises to resolve
                    Promise.all(eventPromises).then(() => {
                        // Sort allEvents array by the event date and time
                        allEvents.sort((a, b) => {
                            // Create date objects for comparison
                            let dateTimeA = new Date(`${a.date}T${a.time}`);
                            let dateTimeB = new Date(`${b.date}T${b.time}`);
                            
                            // Debugging: Log the dates being compared
                            console.log(`Comparing: ${dateTimeA} with ${dateTimeB}`);
                            
                            return dateTimeA - dateTimeB; // Ascending order
                        });
        
                        // Check if sorting works as expected
                        console.log("Sorted Events:", allEvents);
        
                        // Display sorted events
                        allEvents.forEach(event => {
                            const eventItem = document.createElement('div');
                            eventItem.classList.add('event-item');
        
                            // Fetch friend's userId to display the name instead of ID
                            database.ref('users/' + event.createdBy).once('value').then(friendSnapshot => {
                                const friendData = friendSnapshot.val();
                                const creatorName = friendData ? friendData.userId : 'Unknown'; // Fallback if no user data
        
                                // Display event details
                                eventItem.textContent = `${event.title} - ${event.date} at ${event.time} (Created by: ${creatorName})`;
                                friendsEventList.appendChild(eventItem); // Add to the list
                            });
                        });
                    });
                }
            }).catch(error => {
                console.error("Error fetching friends' events:", error);
            });
        }
        
        // Log out function
        document.getElementById('logoutBtn').onclick = function() {
            auth.signOut().then(() => {
                window.location.href = 'index.html';
            }).catch((error) => {
                console.error("Error logging out:", error);
            });
        };

        // Create event button functionality
        document.getElementById('createEventBtn').onclick = createEvent;

        // Event modal functionality
        document.getElementById("submitEventBtn").onclick = submitEvent;
        document.getElementsByClassName("close")[0].onclick = closeModal;

        // Fetch users and requests when the page loads
        auth.onAuthStateChanged(user => {
            if (user) {
                displayUsers();
                displayPendingRequests(); // Fetch and display pending friend requests
                displayAcceptedFriends(); // Fetch and display accepted friends
                displayEvents(); // Fetch and display user's events
                displayFriendsEvents(); // Fetch and display friends' events
            } else {
                window.location.href = 'index.html'; // Redirect if not logged in
            }
        });
    </script>

    <!-- Modal for Event Creation -->
    <div id="eventModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3>Create Event</h3>
            <label for="eventTitle">Event Title:</label>
            <input type="text" id="eventTitle" required>
            <br>
            <label for="eventDate">Event Date:</label>
            <input type="date" id="eventDate" required>
            <br>
            <label for="eventTime">Event Time:</label>
            <input type="time" id="eventTime" required step="900"> <!-- Step set to 900 seconds for 15-minute intervals -->
            <br>
            <button id="submitEventBtn">Create Event</button>
        </div>
    </div>

</body>
</html>
