<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>You are Connected</title>
    <script src="https://www.gstatic.com/firebasejs/9.9.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.9.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.9.0/firebase-database-compat.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: auto;
            margin: 0;
            text-align: center;
        }
        button {
            padding: 10px 15px;
            font-size: 16px;
            margin-top: 20px;
        }
        .user-list, .request-list {
            margin-top: 20px;
            width: 100%;
            max-width: 400px;
            text-align: left;
        }
        .user-item, .request-item {
            padding: 5px;
            border: 1px solid #ccc;
            margin: 5px 0;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <h2>You are connected</h2>
    <button id="logoutBtn">Log Out</button>

    <div class="user-list" id="userList"></div>
    <h3>Pending Friend Requests</h3>
    <div class="request-list" id="requestList"></div>

    <script>
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBB61hJK8iHNAXz2q5u8ghGqIFMyJh-Nho",
            authDomain: "aperosocial-d53c7.firebaseapp.com",
            databaseURL: "https://aperosocial-d53c7-default-rtdb.firebaseio.com",
            projectId: "aperosocial-d53c7",
            storageBucket: "aperosocial-d53c7.appspot.com",
            messagingSenderId: "954205055992",
            appId: "1:954205055992:web:c2ebebe1c0ac210163440d"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // Function to fetch and display users
        function displayUsers() {
            const currentUserId = auth.currentUser.uid; // Get current user's Firebase UID
            
            database.ref('users').once('value').then(snapshot => {
                const userList = document.getElementById('userList');
                userList.innerHTML = ''; // Clear previous list

                // Display current user at the top
                const currentUserData = snapshot.child(currentUserId).val();
                if (currentUserData) {
                    const currentUserItem = document.createElement('div');
                    currentUserItem.classList.add('user-item');
                    currentUserItem.textContent = currentUserData.userId; // Display current user's ID
                    userList.appendChild(currentUserItem); // Add to the list
                }

                snapshot.forEach(childSnapshot => {
                    const userData = childSnapshot.val();
                    const userId = userData.userId;

                    // Skip adding the current user again
                    if (userId === currentUserData?.userId) return;

                    // Create a user item
                    const userItem = document.createElement('div');
                    userItem.classList.add('user-item');
                    userItem.textContent = userId;

                    // Create the + button
                    const addButton = document.createElement('button');
                    addButton.textContent = '+';
                    addButton.onclick = function() {
                        sendFriendRequest(childSnapshot.key, addButton); // Pass user UID and button
                    };

                    // Append button to user item
                    userItem.appendChild(addButton);
                    
                    // Append to the user list
                    userList.appendChild(userItem);
                });
            }).catch(error => {
                console.error("Error fetching users:", error);
            });
        }

        // Function to send a friend request
        function sendFriendRequest(targetUserId, button) {
            const currentUserId = auth.currentUser.uid; // Get current user's Firebase UID
            
            // Update the database to add the friend request under the target user's record
            database.ref('users/' + targetUserId + '/friendRequests/' + currentUserId).set({
                requestingUserId: currentUserId,
                status: 'pending'
            }).then(() => {
                console.log("Friend request sent to " + targetUserId);
                button.textContent = 'Pending'; // Change button text to "Pending"
                button.disabled = true; // Disable the button
            }).catch(error => {
                console.error("Error sending friend request:", error);
            });
        }

        // Function to fetch and display pending friend requests
        function displayPendingRequests() {
            const currentUserId = auth.currentUser.uid; // Get current user's Firebase UID
            
            database.ref('users/' + currentUserId + '/friendRequests').once('value').then(snapshot => {
                const requestList = document.getElementById('requestList');
                requestList.innerHTML = ''; // Clear previous list

                snapshot.forEach(childSnapshot => {
                    const requesterId = childSnapshot.key; // Get the UID of the requester
                    const requesterData = snapshot.child(requesterId).val(); // Get details of the requester

                    const requestItem = document.createElement('div');
                    requestItem.classList.add('request-item');
                    requestItem.textContent = requesterData.requestingUserId; // Display the userId of the requester
                    requestList.appendChild(requestItem); // Add to the list
                });
            }).catch(error => {
                console.error("Error fetching friend requests:", error);
            });
        }

        // Log out function
        document.getElementById('logoutBtn').onclick = function() {
            auth.signOut().then(() => {
                window.location.href = 'index.html';
            }).catch((error) => {
                console.error("Error logging out:", error);
            });
        };

        // Fetch users and pending requests when the page loads
        auth.onAuthStateChanged(user => {
            if (user) {
                displayUsers();
                displayPendingRequests(); // Fetch and display pending friend requests
            } else {
                window.location.href = 'index.html'; // Redirect if not logged in
            }
        });
    </script>
</body>
</html>
