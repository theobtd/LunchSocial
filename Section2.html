<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Section 2</title>
    <script src="https://www.gstatic.com/firebasejs/9.9.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.9.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.9.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.9.0/firebase-storage-compat.js"></script>
    <style>
        html, body {
            height: 100%; /* Set height to 100% for the body and html */
            margin: 0; /* Remove default margin */
        }
        
        body {
            display: flex;
            flex-direction: column; /* Stack elements vertically */
        }
        
        h3 {
            margin: 10px; /* Add some margin to the header */
        }
        
        .event-list {
            border: 1px solid #ccc;
            overflow-y: auto; /* Enable vertical scrolling */
            flex-grow: 1; /* Allow the event list to grow and fill available space */
            margin-top: 10px;
        }
        .event-item {
            background-color: #fff; /* White background for the card */
            border: 1px solid #ccc; /* Light gray border */
            border-radius: 8px; /* Rounded corners */
            padding: 15px; /* Inner padding */
            margin: 10px 0; /* Margin between cards */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); /* Subtle shadow for depth */
            transition: box-shadow 0.3s; /* Smooth transition for hover effect */
        }
        .event-item:hover {
            background-color: #f0f0f0;
        }
        .join-button, .delete-button {
            background-color: #007BFF;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 5px 10px;
            cursor: pointer;
        }
        .delete-button {
            background-color: #FF6F61;
        }
        .participant-row {
            border-bottom: 1px solid #ccc; /* Thin line below the participant badges */
            padding: 10px 0; /* Padding for the row */
            overflow-x: auto; /* Enable horizontal scrolling */
            white-space: nowrap; /* Prevent wrapping of badges */
        }
        .participant-badge {
            display: inline-block; /* Allows badges to sit next to each other */
            background-color: #007BFF; /* Badge background color */
            color: white; /* Text color */
            border-radius: 20px; /* Make it stadium-shaped */
            padding: 5px 15px; /* Padding for the badge */
            margin: 5px; /* Space between badges */
            font-size: 14px; /* Font size */
            text-align: center; /* Center the text */
        }
        .participant-list {
            margin-bottom: 10px; /* Space between the badges and the event details */
        }
    </style>
</head>
<body>
    <h3>Future Events</h3>
    <div class="event-list" id="eventList"></div>

    <script>
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBB61hJK8iHNAXz2q5u8ghGqIFMyJh-Nho",
            authDomain: "aperosocial-d53c7.firebaseapp.com",
            databaseURL: "https://aperosocial-d53c7-default-rtdb.firebaseio.com",
            projectId: "aperosocial-d53c7",
            storageBucket: "aperosocial-d53c7.firebasestorage.app",
            messagingSenderId: "954205055992",
            appId: "1:954205055992:web:c2ebebe1c0ac210163440d"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        let currentUserId;

        auth.onAuthStateChanged(user => {
            if (user) {
                currentUserId = user.uid;
                displayFutureEvents();
            } else {
                // Also remove the line that sets the welcome message for guests
            }
        });

        function displayFutureEvents() {
            const eventList = document.getElementById('eventList');
            eventList.innerHTML = ''; // Clear existing events
    
            // Fetch the user's own events
            const userEventsRef = database.ref(`users/${currentUserId}/events`);
            const visibleEventsRef = database.ref(`users/${currentUserId}/visibleEvents`);
    
            Promise.all([
                userEventsRef.once('value'),
                visibleEventsRef.once('value'),
            ]).then(([userEventSnapshot, visibleEventSnapshot]) => {
                const allEvents = [];
    
                // Gather user's own events
                userEventSnapshot.forEach(eventChildSnapshot => {
                    const eventData = eventChildSnapshot.val();
                    const eventId = eventChildSnapshot.key;
                    const eventDateTime = new Date(`${eventData.date}T${eventData.time}:00`);
    
                    // Check if the event is in the future
                    if (eventDateTime > new Date()) {
                        allEvents.push({ eventData, eventId, eventDateTime });
                    }
                });
    
                // Gather visible events
                visibleEventSnapshot.forEach(eventChildSnapshot => {
                    const eventData = eventChildSnapshot.val();
                    const eventId = eventChildSnapshot.key;
                    const eventDateTime = new Date(`${eventData.date}T${eventData.time}:00`);
    
                    // Check if the event is in the future
                    if (eventDateTime > new Date()) {
                        allEvents.push({ eventData, eventId, eventDateTime });
                    }
                });
    
                // Sort events by date and time
                allEvents.sort((a, b) => a.eventDateTime - b.eventDateTime);
    
                // Function to display events one by one
                const displayNextEvent = (index) => {
                    if (index < allEvents.length) {
                        const { eventData, eventId } = allEvents[index];
                        addEventToList(eventData, eventId, eventData.createdBy); // Use createdBy as the targetUserId
    
                        setTimeout(() => {
                            displayNextEvent(index + 1); // Fetch next event after a delay
                        }, 100); // Adjust delay as needed
                    }
                };
    
                // Start displaying events
                displayNextEvent(0);
            }).catch(error => {
                console.error("Error fetching events:", error);
            });
        }
        
        function addEventToList(eventData, eventId, targetUserId) {
            const eventList = document.getElementById('eventList');
            const eventItem = document.createElement('div');
            eventItem.classList.add('event-item'); // Apply card class
        
            // Fetch participants for display
            const participantsRef = database.ref(`users/${targetUserId}/events/${eventId}/participants`);
            
            participantsRef.once('value').then(participantSnapshot => {
                const participantsUids = participantSnapshot.val() || [];
                
                // Get user IDs based on UIDs
                const userPromises = participantsUids.map(uid => {
                    return database.ref(`users/${uid}/userId`).once('value').then(userIdSnapshot => {
                        return userIdSnapshot.val(); // Get the user ID
                    });
                });
        
                // Always include the organizer
                userPromises.push(database.ref(`users/${eventData.createdBy}/userId`).once('value').then(userIdSnapshot => {
                    return userIdSnapshot.val(); // Get the organizer's user ID
                }));
        
                return Promise.all(userPromises).then(userIds => {
                    // Filter out any null values and ensure the organizer is included
                    const uniqueParticipants = Array.from(new Set(userIds.filter(id => id)));
                    const participantList = uniqueParticipants.map(id => 
                        `<span class="participant-badge">${id}</span>` // Create stadium shape for each participant
                    ).join(' '); // Join badges with space
                    
                    eventItem.innerHTML = `
                        <div class="participant-row">
                            ${participantList}
                        </div>
                        <strong>${eventData.title}</strong><br>
                        <em>Date:</em> ${eventData.date} at ${eventData.time}<br>
                        <em>Location:</em> ${eventData.location || "N/A"}<br>
                        <em>Comment:</em> ${eventData.comment || "N/A"}<br>
                        <em>Category:</em> ${eventData.category || "N/A"}<br>
                    `;
        
                    const actionButton = document.createElement('button');
                    actionButton.classList.add('join-button');
        
                    if (eventData.createdBy === currentUserId) {
                        actionButton.textContent = 'Delete Event';
                        actionButton.classList.remove('join-button');
                        actionButton.classList.add('delete-button');
                        actionButton.onclick = () => deleteEvent(eventId);
                    } else {
                        const isParticipant = participantsUids.includes(currentUserId);
                        actionButton.textContent = isParticipant ? 'Leave Event' : 'Join!';
        
                        actionButton.onclick = () => {
                            toggleParticipation(eventId, targetUserId, actionButton, isParticipant);
                        };
                    }
        
                    eventItem.appendChild(actionButton);
                    eventList.appendChild(eventItem);
                });
            });
        }

        function toggleParticipation(eventId, targetUserId, button, isParticipant) {
            const participantsRef = database.ref(`users/${targetUserId}/events/${eventId}/participants`);
        
            if (isParticipant) {
                // Remove participant
                participantsRef.once('value').then(snapshot => {
                    let participants = snapshot.val() || [];
                    participants = participants.filter(participant => participant !== currentUserId);
                    return participantsRef.set(participants);
                }).then(() => {
                    button.textContent = 'Join!'; // Update button text
                    button.onclick = () => toggleParticipation(eventId, targetUserId, button, false); // Update click event
                    console.log(`User ${currentUserId} left the event ${eventId}`);
                }).catch(error => {
                    console.error('Error updating participants:', error);
                });
            } else {
                // Add participant
                participantsRef.once('value').then(snapshot => {
                    let participants = snapshot.val() || [];
                    participants.push(currentUserId);
                    return participantsRef.set(participants);
                }).then(() => {
                    button.textContent = 'Leave Event'; // Update button text
                    button.onclick = () => toggleParticipation(eventId, targetUserId, button, true); // Update click event
                    console.log(`User ${currentUserId} joined the event ${eventId}`);
                }).catch(error => {
                    console.error('Error updating participants:', error);
                });
            }
        }

        function refreshButtonState(eventId, targetUserId, button) {
            const participantsRef = database.ref(`users/${targetUserId}/events/${eventId}/participants`);
            participantsRef.once('value').then(snapshot => {
                const participants = snapshot.val() || [];
                const isParticipant = participants.includes(currentUserId);
                button.textContent = isParticipant ? 'Leave Event' : 'Join!';
            });
        }

        function deleteEvent(eventId) {
            const eventRef = database.ref(`users/${currentUserId}/events/${eventId}`);
    
            // First, get the event data to find out who has access
            eventRef.once('value').then(snapshot => {
                const eventData = snapshot.val();
                console.log("Event Data Retrieved for Deletion:", eventData); // Log entire event data
    
                if (eventData) {
                    // Check if visibleTo exists and is an array
                    const visibleTo = Array.isArray(eventData.visibleTo) ? eventData.visibleTo : [];
                    console.log("Visible To Users:", visibleTo); // Log visibleTo array
    
                    // Filter out the event creator from the visibleTo list
                    const nonCreatorUsers = visibleTo.filter(userId => userId !== currentUserId);
                    console.log("Non-Creator Users:", nonCreatorUsers); // Log non-creator users
    
                    // Now delete from each user's visibleEvents
                    const deletePromises = nonCreatorUsers.map(userId => {
                        console.log(`Attempting to delete event ${eventId} from user ${userId}'s visibleEvents`);
                        const userVisibleEventRef = database.ref(`users/${userId}/visibleEvents/${eventId}`);
                        return userVisibleEventRef.remove().then(() => {
                            console.log(`Event ${eventId} deleted from ${userId}'s visibleEvents`);
                        }).catch(error => {
                            console.error(`Error deleting event ${eventId} from ${userId}'s visibleEvents:`, error);
                        });
                    });
    
                    // Wait for all deletions to complete, then delete the event from the creator's path
                    return Promise.all(deletePromises).then(() => {
                        console.log(`All visibleEvents for event ${eventId} deleted. Now deleting from creator's path.`);
                        return eventRef.remove(); // Remove the event from the event creator's path
                    });
                } else {
                    console.error('Event data not found for deletion.');
                    throw new Error('Event data not found.');
                }
            }).then(() => {
                console.log("Event deleted successfully.");
                displayFutureEvents(); // Refresh the events display
            }).catch(error => {
                console.error("Error deleting event:", error);
            });
        }
    </script>

    <div class="menu-bar" style="position: fixed; bottom: 0; left: 0; right: 0; background: #333; display: flex; justify-content: space-around; padding: 10px; color: white;">
        <a href="Section1.html" style="color: white;">Section 1</a>
        <a href="Section2.html" style="color: white;">Section 2</a>
        <a href="Section3.html" style="color: white;">Section 3</a>
        <a href="Section4.html" style="color: white;">Section 4</a>
    </div>
</body>
</html>
