<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Section 2</title>
    <script src="https://www.gstatic.com/firebasejs/9.9.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.9.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.9.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.9.0/firebase-storage-compat.js"></script>
    <style>
        html, body {
            height: 100%; /* Set height to 100% for the body and html */
            margin: 0; /* Remove default margin */
        }
        
        body {
            display: flex;
            flex-direction: column; /* Stack elements vertically */
        }
        
        h3 {
            margin: 10px; /* Add some margin to the header */
        }
        
        .event-list {
            border: 1px solid #ccc;
            overflow-y: auto; /* Enable vertical scrolling */
            flex-grow: 1; /* Allow the event list to grow and fill available space */
            margin-top: 10px;
        }
        .event-item {
            background-color: #fff; /* White background for the card */
            border: 1px solid #ccc; /* Light gray border */
            border-radius: 8px; /* Rounded corners */
            padding: 15px; /* Inner padding */
            margin: 10px 0; /* Margin between cards */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); /* Subtle shadow for depth */
            transition: box-shadow 0.3s; /* Smooth transition for hover effect */
        }
        .event-item:hover {
            background-color: #f0f0f0;
        }
        .delete-button {
            background-color: #FF6F61;
        }
        .participant-container {
            display: flex; /* Use flexbox for horizontal layout */
            overflow-x: auto; /* Enable horizontal scrolling */
            white-space: nowrap; /* Prevent wrapping */
            margin-bottom: 10px; /* Space below the badge container */
        }
        .participant-badge {
            display: inline-block; /* Allows badges to sit next to each other */
            background-color: #007BFF; /* Badge background color */
            color: white; /* Text color */
            border-radius: 20px; /* Make it stadium-shaped */
            padding: 5px 15px; /* Padding for the badge */
            margin: 5px; /* Space between badges */
            font-size: 14px; /* Font size */
            text-align: center; /* Center the text */
            margin-right: 5px; /* Space between badges */
        }

        .toggle-button-container {
            display: flex;
            justify-content: center; /* Center the toggle buttons */
            margin-top: 10px; /* Space above the toggle */
            position: relative; /* For absolute positioning of buttons */
        }
        
        .toggle-button {
            display: flex; /* Use flexbox for layout */
            position: relative; /* For positioning child elements */
            width: 100px; /* Width of the toggle button */
            height: 40px; /* Height of the toggle button */
            border-radius: 20px; /* Rounded corners */
            background-color: #ccc; /* Default background */
            cursor: pointer; /* Pointer cursor for interactivity */
            transition: background-color 0.3s; /* Smooth background transition */
        }
        
        .toggle-button.active {
            background-color: #007BFF; /* Background color when active */
        }
        
        .join-button, .leave-button {
            border: none; /* Remove default border */
            border-radius: 20px; /* Rounded corners */
            color: white; /* Button text color */
            width: 50%; /* Each button takes half the width */
            height: 100%; /* Full height of the toggle */
            cursor: pointer; /* Pointer cursor */
            transition: opacity 0.3s; /* Smooth opacity transition */
        }
        
        .leave-button {
            background-color: #FF6F61; /* Leave button background color */
        }
        
        .join-button {
            background-color: #007BFF; /* Join button background color */
        }
        
        .toggle-button.active .join-button {
            opacity: 0; /* Hide the Join button when active */
        }
        
        .toggle-button.active .leave-button {
            opacity: 1; /* Show the Leave button when active */
        }
        
        .toggle-button .join-button {
            opacity: 1; /* Show the Join button by default */
        }
        
        .toggle-button .leave-button {
            opacity: 0; /* Hide the Leave button by default */
        }
    </style>
</head>
<body>
    <h3>Future Events</h3>
    <div class="event-list" id="eventList"></div>

    <script>
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBB61hJK8iHNAXz2q5u8ghGqIFMyJh-Nho",
            authDomain: "aperosocial-d53c7.firebaseapp.com",
            databaseURL: "https://aperosocial-d53c7-default-rtdb.firebaseio.com",
            projectId: "aperosocial-d53c7",
            storageBucket: "aperosocial-d53c7.firebasestorage.app",
            messagingSenderId: "954205055992",
            appId: "1:954205055992:web:c2ebebe1c0ac210163440d"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        let currentUserId;

        auth.onAuthStateChanged(user => {
            if (user) {
                currentUserId = user.uid;
                displayFutureEvents();
            } else {
                // Also remove the line that sets the welcome message for guests
            }
        });

        function displayFutureEvents() {
            const eventList = document.getElementById('eventList');
            eventList.innerHTML = '';
        
            const addedEvents = []; // Array to hold all events
            const addedEventIds = new Set(); // To track added event IDs
        
            // First, fetch all events from other users
            database.ref('users').once('value').then(snapshot => {
                const promises = []; // Array to hold promises for async operations
        
                snapshot.forEach(childSnapshot => {
                    const targetUserId = childSnapshot.key;
        
                    const promise = database.ref(`users/${targetUserId}/events`).once('value').then(eventSnapshot => {
                        eventSnapshot.forEach(eventChildSnapshot => {
                            const eventData = eventChildSnapshot.val();
                            const eventId = eventChildSnapshot.key;
                            const eventDateTime = new Date(`${eventData.date}T${eventData.time}:00`);
        
                            // Check if the event is in the future
                            if (eventDateTime > new Date()) {
                                const isVisible = eventData.visibleTo && eventData.visibleTo.includes(currentUserId);
        
                                // Add event to array if user has access
                                if (isVisible) {
                                    addedEvents.push({ eventData, eventId, targetUserId, eventDateTime });
                                    addedEventIds.add(eventId); // Track added event ID
                                }
                            }
                        });
                    });
        
                    promises.push(promise); // Add promise to the array
                });
        
                return Promise.all(promises); // Wait for all user events to be fetched
            }).then(() => {
                // Then, fetch the user's own events
                return database.ref(`users/${currentUserId}/events`).once('value');
            }).then(eventSnapshot => {
                eventSnapshot.forEach(eventChildSnapshot => {
                    const eventData = eventChildSnapshot.val();
                    const eventId = eventChildSnapshot.key;
                    const eventDateTime = new Date(`${eventData.date}T${eventData.time}:00`);
        
                    // Check if the event is in the future and not already added
                    if (eventDateTime > new Date() && !addedEventIds.has(eventId)) {
                        addedEvents.push({ eventData, eventId, targetUserId: currentUserId, eventDateTime });
                    }
                });
            }).then(() => {
                // Sort events by date and time
                addedEvents.sort((a, b) => a.eventDateTime - b.eventDateTime);
        
                // Display sorted events
                addedEvents.forEach(({ eventData, eventId, targetUserId }) => {
                    addEventToList(eventData, eventId, targetUserId);
                });
            }).catch(error => {
                console.error("Error fetching events:", error);
            });
        }
        
        function addEventToList(eventData, eventId, targetUserId) {
            const eventList = document.getElementById('eventList');
            const eventItem = document.createElement('div');
            eventItem.classList.add('event-item'); // Apply card class
        
            // Fetch participants for display
            const participantsRef = database.ref(`users/${targetUserId}/events/${eventId}/participants`);
            
            participantsRef.once('value').then(participantSnapshot => {
                const participantsUids = participantSnapshot.val() || [];
                
                // Get user IDs based on UIDs
                const userPromises = participantsUids.map(uid => {
                    return database.ref(`users/${uid}/userId`).once('value').then(userIdSnapshot => {
                        return userIdSnapshot.val(); // Get the user ID
                    });
                });
        
                // Always include the organizer
                userPromises.push(database.ref(`users/${eventData.createdBy}/userId`).once('value').then(userIdSnapshot => {
                    return userIdSnapshot.val(); // Get the organizer's user ID
                }));
        
                return Promise.all(userPromises).then(userIds => {
                    // Filter out any null values and ensure the organizer is included
                    const uniqueParticipants = Array.from(new Set(userIds.filter(id => id)));
                    const participantList = uniqueParticipants.map(id => 
                        `<span class="participant-badge">${id}</span>` // Create stadium shape for each participant
                    ).join(' '); // Join badges with space
                    
                    // Insert participant badges in a scrollable container
                    eventItem.innerHTML = `
                        <div class="participant-container">${participantList || "None"}</div>
                        <div class="separator"></div>
                        <strong>${eventData.title}</strong><br>
                        <em>Date:</em> ${eventData.date} at ${eventData.time}<br>
                        <em>Location:</em> ${eventData.location || "N/A"}<br>
                        <em>Comment:</em> ${eventData.comment || "N/A"}<br>
                        <em>Category:</em> ${eventData.category || "N/A"}<br>
                        <div class="toggle-button-container">
                            <div class="toggle-button ${participantsUids.includes(currentUserId) ? 'active' : ''}" 
                                 onclick="toggleParticipation('${eventId}', '${targetUserId}', this)">
                                <button class="join-button">Join!</button>
                                <button class="leave-button">Leave Event</button>
                            </div>
                        </div>
                    `;
        
                    eventList.appendChild(eventItem);
                });
            });
        }

        function toggleParticipation(eventId, targetUserId, buttonContainer) {
            const participantsRef = database.ref(`users/${targetUserId}/events/${eventId}/participants`);
            const participantListContainer = buttonContainer.closest('.event-item').querySelector('.participant-container');
        
            participantsRef.once('value').then(snapshot => {
                let participants = snapshot.val() || [];
                const isParticipant = participants.includes(currentUserId);
        
                if (isParticipant) {
                    // Remove participant
                    participants = participants.filter(participant => participant !== currentUserId);
                    return participantsRef.set(participants).then(() => {
                        buttonContainer.classList.remove('active'); // Remove active class
                        updateParticipantList(participantListContainer, participants, currentUserId); // Update the UI
                        console.log(`User ${currentUserId} left the event ${eventId}`);
                    });
                } else {
                    // Add participant
                    participants.push(currentUserId);
                    return participantsRef.set(participants).then(() => {
                        buttonContainer.classList.add('active'); // Add active class
                        updateParticipantList(participantListContainer, participants, currentUserId); // Update the UI
                        console.log(`User ${currentUserId} joined the event ${eventId}`);
                    });
                }
            }).catch(error => {
                console.error('Error updating participants:', error);
            });
        }
        
        function updateParticipantList(participantListContainer, participants, eventData) {
            // Create an array of promises to fetch user IDs for all participants
            const userIdPromises = participants.map(uid => {
                return database.ref(`users/${uid}/userId`).once('value').then(snapshot => {
                    return snapshot.val(); // Get the user ID
                });
            });
        
            // Always include the event creator's user ID
            userIdPromises.push(database.ref(`users/${eventData.createdBy}/userId`).once('value').then(snapshot => {
                return snapshot.val(); // Get the creator's user ID
            }));
        
            // Wait for all promises to resolve
            Promise.all(userIdPromises).then(userIds => {
                // Filter out any null values and ensure the creator's ID is included
                const uniqueUserIds = Array.from(new Set(userIds)).filter(id => id);
        
                // Create badges with user IDs
                const participantList = uniqueUserIds.map(id => 
                    `<span class="participant-badge">${id}</span>` // Create stadium shape for each participant
                ).join(' '); // Join badges with space
        
                // Update the participant list in the UI
                participantListContainer.innerHTML = participantList.length ? participantList : "None";
            }).catch(error => {
                console.error('Error fetching user IDs:', error);
            });
        }

        function refreshButtonState(eventId, targetUserId, button) {
            const participantsRef = database.ref(`users/${targetUserId}/events/${eventId}/participants`);
            participantsRef.once('value').then(snapshot => {
                const participants = snapshot.val() || [];
                const isParticipant = participants.includes(currentUserId);
                button.textContent = isParticipant ? 'Leave Event' : 'Join!';
            });
        }

        function deleteEvent(eventId) {
            const eventRef = database.ref(`users/${currentUserId}/events/${eventId}`);
            eventRef.remove().then(() => {
                displayFutureEvents(); // Refresh the events display
            }).catch(error => {
                console.error("Error deleting event:", error);
            });
        }
    </script>

    <div class="menu-bar" style="position: fixed; bottom: 0; left: 0; right: 0; background: #333; display: flex; justify-content: space-around; padding: 10px; color: white;">
        <a href="Section1.html" style="color: white;">Section 1</a>
        <a href="Section2.html" style="color: white;">Section 2</a>
        <a href="Section3.html" style="color: white;">Section 3</a>
        <a href="Section4.html" style="color: white;">Section 4</a>
    </div>
</body>
</html>
