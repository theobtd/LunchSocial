<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Section 3</title>
    <script src="https://www.gstatic.com/firebasejs/9.9.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.9.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.9.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.9.0/firebase-storage-compat.js"></script>
    <style>
        html, body {
            height: 100%;
            margin: 0;
        }

        body {
            display: flex;
            flex-direction: column;
        }

        h3 {
            margin: 10px;
        }

        .event-list {
            display: flex;
            flex-direction: column;
            border: 1px solid #ccc;
            overflow-y: auto;
            flex-grow: 1;
            margin-top: 10px;
        }

        .event-item {
            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            transition: box-shadow 0.3s;
        }

        .event-item:hover {
            background-color: #f0f0f0;
        }

        .carousel img {
            width: 100%;
            height: auto;
            display: none;
        }

        .carousel img.active {
            display: block;
        }

        .delete-button {
            background-color: #FF6F61;
        }

        .menu-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #333;
            display: flex;
            justify-content: space-around;
            padding: 10px;
            color: white;
        }
    </style>
</head>
<body>
    <h3>Future Events</h3>
    <div class="event-list" id="eventList"></div>

    <script>
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBB61hJK8iHNAXz2q5u8ghGqIFMyJh-Nho",
            authDomain: "aperosocial-d53c7.firebaseapp.com",
            databaseURL: "https://aperosocial-d53c7-default-rtdb.firebaseio.com",
            projectId: "aperosocial-d53c7",
            storageBucket: "aperosocial-d53c7.firebasestorage.app",
            messagingSenderId: "954205055992",
            appId: "1:954205055992:web:c2ebebe1c0ac210163440d"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        const storage = firebase.storage();

        let currentUserId;

        auth.onAuthStateChanged(user => {
            if (user) {
                currentUserId = user.uid;
                displayFutureEvents();
            }
        });

        async function displayFutureEvents() {
            const eventList = document.getElementById('eventList');
            eventList.innerHTML = '';
            const addedEvents = [];

            // Fetch user's events and friends' events
            const snapshot = await database.ref(`users/${currentUserId}/events`).once('value');
            snapshot.forEach(childSnapshot => {
                const eventData = childSnapshot.val();
                eventData.id = childSnapshot.key; // Add ID for later use
                addedEvents.push(eventData);
            });

            addedEvents.forEach(event => {
                addEventToList(event);
            });
        }

        function addEventToList(eventData) {
            const eventList = document.getElementById('eventList');
            const eventItem = document.createElement('div');
            eventItem.classList.add('event-item');

            eventItem.innerHTML = `
                <strong>${eventData.title}</strong><br>
                <em>Date:</em> ${eventData.date} at ${eventData.time}<br>
                <em>Location:</em> ${eventData.location || "N/A"}<br>
                <em>Comment:</em> ${eventData.comment || "N/A"}<br>
                <em>Category:</em> ${eventData.category || "N/A"}<br>
                <button onclick="openEventDetails('${eventData.id}')">Pictures</button>
            `;

            eventList.appendChild(eventItem);
            fetchEventPictures(eventData.id, eventItem); // Fetch pictures for the event
        }

        function fetchEventPictures(eventId, eventItem) {
            database.ref(`events/${eventId}/pictures`).once('value').then(snapshot => {
                const pictures = [];
                snapshot.forEach(childSnapshot => {
                    const pictureData = childSnapshot.val();
                    pictures.push(pictureData.url);
                });
                if (pictures.length > 0) {
                    createCarousel(eventItem, pictures);
                }
            });
        }

        function createCarousel(eventItem, pictures) {
            const carouselContainer = document.createElement('div');
            carouselContainer.classList.add('carousel');

            pictures.forEach((url, index) => {
                const img = document.createElement('img');
                img.src = url;
                img.classList.toggle('active', index === 0); // Show the first image
                carouselContainer.appendChild(img);
            });

            eventItem.appendChild(carouselContainer);
        }

        function uploadCroppedImage(blob, eventId) {
            const storageRef = storage.ref(`event_pictures/${eventId}/cropped_${Date.now()}.jpg`);
            const uploadTask = storageRef.put(blob);
            // Handle upload progress and completion
        }

        // Add picture upload and cropping functionality
        document.getElementById('uploadPictureBtn').onclick = function() {
            const fileInput = document.getElementById('eventUploadPictureInput');
            const file = fileInput.files[0];
            if (!file) return;

            const imageUrl = URL.createObjectURL(file);
            const cropImageElement = document.getElementById('cropperImage');
            cropImageElement.src = imageUrl;

            const modal = document.getElementById('cropModal');
            modal.style.display = 'block';
            const cropper = new Cropper(cropImageElement, { aspectRatio: 1, viewMode: 1 });

            document.getElementById('cropBtn').onclick = function() {
                const canvas = cropper.getCroppedCanvas({ width: 1080, height: 1080 });
                canvas.toBlob(blob => uploadCroppedImage(blob, currentEventId));
                modal.style.display = 'none';
            };
        };

        function openEventDetails(eventId) {
            // Fetch event details and show pictures
        }

    </script>

    <div class="menu-bar">
        <a href="Section1.html">Section 1</a>
        <a href="Section2.html">Section 2</a>
        <a href="Section3.html">Section 3</a>
        <a href="Section4.html">Section 4</a>
    </div>

    <!-- Modal for cropping images -->
    <div id="cropModal" style="display: none;">
        <div>
            <img id="cropperImage" src="" style="max-width: 100%;">
            <button id="cropBtn">Crop & Upload</button>
            <button id="cancelBtn">Cancel</button>
        </div>
    </div>
</body>
</html>
