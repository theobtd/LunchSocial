<script>
    // Your Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyBB61hJK8iHNAXz2q5u8ghGqIFMyJh-Nho",
        authDomain: "aperosocial-d53c7.firebaseapp.com",
        databaseURL: "https://aperosocial-d53c7-default-rtdb.firebaseio.com",
        projectId: "aperosocial-d53c7",
        storageBucket: "aperosocial-d53c7.firebasestorage.app",
        messagingSenderId: "954205055992",
        appId: "1:954205055992:web:c2ebebe1c0ac210163440d"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const database = firebase.database();

    // Check if user is authenticated
    auth.onAuthStateChanged(user => {
        if (user) {
            currentUserId = user.uid; // Set currentUserId to the authenticated user's ID
            loadFriends(); // Load friends only after user is authenticated
        } else {
            console.log('No user is signed in.');
            // Optionally, redirect to login page or show a message
        }
    });

    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('createEventButton').addEventListener('click', createEvent);
    });

    function loadFriends() {
        const friendsRef = database.ref(`users/${currentUserId}/friends`);
        friendsRef.once('value').then(snapshot => {
            const friendsList = document.getElementById('friendsList');
            friendsList.innerHTML = ''; // Clear existing friends list

            snapshot.forEach(childSnapshot => {
                const friendId = childSnapshot.key;
                const friendName = childSnapshot.val(); // Assuming friend's name is stored
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = friendId;
                checkbox.value = friendId;

                const label = document.createElement('label');
                label.htmlFor = friendId;
                label.innerText = friendName;

                const div = document.createElement('div');
                div.appendChild(checkbox);
                div.appendChild(label);
                friendsList.appendChild(div);
            });
        });
    }

    function createEvent() {
        const eventTitle = document.getElementById('eventTitle').value;
        const eventDate = document.getElementById('eventDate').value;
        const eventTime = document.getElementById('eventTime').value;
        const eventDescription = document.getElementById('eventDescription').value;

        const visibleUserIds = Array.from(document.querySelectorAll('.friends-list input:checked')).map(checkbox => checkbox.value);

        const eventData = {
            title: eventTitle,
            date: eventDate,
            time: eventTime,
            description: eventDescription,
            createdBy: currentUserId, // Ensure this is set correctly
        };

        const newEventRef = database.ref('events').push(); // Create a new event
        const eventId = newEventRef.key;

        // Save event data
        newEventRef.set(eventData).then(() => {
            // Update each authorized userâ€™s path
            visibleUserIds.forEach(userId => {
                const userRef = database.ref(`users/${userId}/visibleEvents/${eventId}`);
                userRef.set(true); // Mark the event as visible for this user
            });
            document.getElementById('statusMessage').innerText = 'Event created successfully!';
        }).catch(error => {
            console.error("Error creating event:", error);
            document.getElementById('statusMessage').innerText = 'Error creating event.';
        });
    }
</script>
